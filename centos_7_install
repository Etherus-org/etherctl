#!/usr/bin/env sh
#
# Copyright (C) 2019 Anton Filatov <ya-enot@mail.ru>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.
#

SERVICENAME='etherus'
SERVICEPATH='/opt/etherus'
SERVICECTLS="$SERVICEPATH/etherctl"

###################################################################################################

_cmd_() {
    obey install
}

_cmd_install() {
    obey version && \
    obey synctime || {
        local EXIT=$?
        echo "Failed to synchronise time. Please do it manually then try again."
        return $EXIT
    } && \
    obey init && \
    obey rollout "$@" && \
    echo "Etherus installed successfully" || {
        local EXIT=$?
        echo "Etherus installation failed"
        return $EXIT
    }
    obey firewall || {
        echo "Firewall was not configured"
        echo "Please open ports 6656/tcp, 6657/tcp and 6660/tcp manually..."
    }
    obey install_service || {
        echo "Etherus daemon was not installed"
    }
}

_cmd_version() {
    echo "Etherus install script v0.1.7"
}

_cmd_synctime() {
    _synctime_check_ntpenabled || {
        echo "Precise time is required by Etherus" >&2
        echo "Please check the time synchronization consistency" >&2
        _synctime_check_ntpsynced
    }
}

_synctime_check_ntpenabled() {
    local NTPENABLED;
    NTPENABLED="$( (timedatectl | grep 'NTP enabled:' | sed 's/.*: \(.*\)/\1/') 2>&1 )" && {
        case "$NTPENABLED" in
            [Yy]* ) echo "Time synchronization enabled"
            ;;
            [Nn]* ) echo "Time synchronization disabled" >&2
            return 1
            ;;
            * ) echo "Time synchronization is: $NTPENABLED" >&2
            return 2
        esac
    } || {
        echo "Failed to detect time synchronization: $NTPENABLED" >&2
        return 3
    }
}

_synctime_check_ntpsynced() {
    local NTPSYNCED;
    NTPSYNCED="$( (timedatectl | grep 'NTP synchronized:' | sed 's/.*: \(.*\)/\1/') 2>&1 )" && {
        case "$NTPSYNCED" in
            [Yy]* ) echo "Time synchronized"
            ;;
            [Nn]* ) echo "Time not synchronized" >&2
            return 1
            ;;
            * ) echo "Time synchronization state is: $NTPSYNCED" >&2
            return 2
        esac
    } || {
        echo "Failed to detect time synchronization state: $NTPSYNCED" >&2
        return 3
    }
}

_cmd_init() {
    id -u "$SERVICENAME" &>/dev/null || {
        useradd -d "$SERVICEPATH" -r -s /bin/false "$SERVICENAME" || {
            echo "Failed to create service user: $SERVICENAME" >&2
            return 1
        }
    }

    [ -d "$SERVICEPATH/" ] || {
        mkdir -m 750 -p "$SERVICEPATH/" || {
            echo "Failed to create service directory: $SERVICEPATH" >&2
            return 2
        }
        chown -R "$SERVICENAME:$SERVICENAME" "$SERVICEPATH/" || {
            echo "Failed to change service directory owner: $SERVICEPATH" >&2
            return 3
        }
    }

    [ -d "$SERVICEPATH/bin" ] || {
        mkdir -m 750 -p "$SERVICEPATH/bin" || {
            echo "Failed to create binaries directory: $SERVICEPATH" >&2
            return 4
        }
        chown -R "$SERVICENAME:$SERVICENAME" "$SERVICEPATH/bin" || {
            echo "Failed to change binaries directory owner: $SERVICEPATH" >&2
            return 5
        }
    }

    [ -x "$SERVICECTLS" ] && [ "$(cat "$SERVICECTLS" | md5sum)" = "$(getFile 'etherctl' | md5sum)" ] || {
        touch "$SERVICECTLS" && \
        chmod 755 "$SERVICECTLS" && \
        getFile 'etherctl' > "$SERVICECTLS" || {
            echo "Failed to download service control script" >&2
            return 6
        }
    }
}

_args_rollout() {
    local ARGNAME
    while [ $# -gt 0 ]
    do
        case "$1" in
        -vpk|--validator-private-key)
            ARGNAME="ROLLOUT_VALIDATOR_PRIVATE_KEY"
            ;;
        -vcn|--validator-create-number)
            ARGNAME="ROLLOUT_VALIDATOR_CREATE_NUMBER"
            ;;
        *)
            [ "$ARGNAME" = "" ] && {
                echo "Invalid parameter: $1" >&2
                return 1
            }
            case "$ARGNAME" in
            ROLLOUT_VALIDATOR_PRIVATE_KEY)
                ROLLOUT_VALIDATOR_PRIVATE_KEY+=("$1")
                ;;
            ROLLOUT_VALIDATOR_CREATE_NUMBER)
                ROLLOUT_VALIDATOR_CREATE_NUMBER=$(($1))
                ;;
            *)
                return 2
            esac
        esac
        shift # next parameter
    done
}

_cmd_rollout() {
    [ "$(id -u)" = "$(id -u "$SERVICENAME")" ] || {
        [ -z "$CENTOS7INSTALLSUBSHELL" ] || {
            echo "Failed to run rollout as $SERVICENAME" >&2
            return 1
        }
        export CENTOS7INSTALLSUBSHELL=$$
        su "$SERVICENAME" -s "$(command -v sh || command -v bash)" -c "$0 rollout $(echo "$@")" || {
            echo "Failed to run rollout" >&2
            return 2
        }
        return 0
    }
    _args_rollout "$@" || {
        local EXITCODE=$?
        echo "Failed to parse arguments for rollout: $@" >&2
        return $EXITCODE
    }
    [ -d "$SERVICEPATH/" ] && cd "$SERVICEPATH/" || {
        echo "Unable to access service directory: $SERVICEPATH" >&2
        return 3
    }
    ( PEERS="07e21d35df9ff6ecce28a5f494d95b990da305bc@master.etherus.org:6656" "$SERVICECTLS" "new" ) || {
        echo "Sentry Node creation failed" >&2
        return 10
    }
    getFile "$(pwd)/config" "genesis.json" > "$("$SERVICECTLS" "path")/data/tenderus/config/genesis.json" || {
        echo "Failed to write Etherus genesis to Sentry Node" >&2
        return 11
    }
    local SNID="$("$SERVICECTLS" "getNodeId")" || {
        echo "Failed to get Sentry Node ID" >&2
        return 12
    }
    echo "$SNID" | grep -Eq '^[0-9a-fA-F]{40}$' || {
        echo "Invalid Sentry Node ID: $SNID" >&2
        return 13
    }
    local VALPUBS=()
    createValidator() {
        local NODEPATH="$("$SERVICECTLS" "path_$1")"
        [ -d "$NODEPATH/data/tenderus/config" ] && {
            echo "Validator Node $1 already exists" >&2
            return 20
        }
        mkdir -p "$NODEPATH/data/tenderus/config" || {
            echo "Validator Node $1 preparation failed" >&2
            return 21
        }
        getFile "$(pwd)/config" "genesis.json" > "$NODEPATH/data/tenderus/config/genesis.json" || {
            echo "Failed to write Etherus genesis to Validator Node" >&2
            return 22
        }
        [ $(($1)) -gt 0 ] && [ "${ROLLOUT_VALIDATOR_PRIVATE_KEY[$(($1-1))]}" != "" ] && {
            local PRIVATE_KEY="${ROLLOUT_VALIDATOR_PRIVATE_KEY[$(($1-1))]}"
            PRIVATE_KEY="$(
                case "$PRIVATE_KEY" in
                H4sI*)
                    DECODE() { 
                        base64 -d | gunzip
                    }
                    ;;
                \{*)
                    DECODE() { 
                        cat
                    }
                    ;;
                *)
                    DECODE() { 
                        base64 -d
                    }
                esac
                ( echo "$PRIVATE_KEY" | DECODE ) 2>/dev/null
            )" && [ ! -z "$PRIVATE_KEY" ] && { #"
                echo "Using specified private key $(echo "$PRIVATE_KEY" | md5sum | sed 's/\([0-9a-fA-F]\+\).*/\1/g')"
                echo "$PRIVATE_KEY" > "$NODEPATH/data/tenderus/config/priv_validator.json"
            } || {
                echo "Failed to set private key for Validator Node $1. Using autogenerated..." >&2
            }
        }
        ( PEERS="$SNID@127.0.0.1:6656" "$SERVICECTLS" "new_$1_private" ) || {
            echo "Validator Node $1 creation failed" >&2
            return 23
        }
        local VNID="$("$SERVICECTLS" "getNodeId_$1")" || {
            echo "Failed to get Validator Node $1 ID" >&2
            return 24
        }
        echo "$VNID" | grep -Eq '^[0-9a-fA-F]{40}$' || {
            echo "Invalid Validator Node $1 ID: $VNID" >&2
            return 25
        }
        "$SERVICECTLS" "addPrivatePeer $VNID" || {
            echo "Failed to add Validator Node $1 as peer to Sentry Node" >&2
            return 26
        }
        local VALPUB="$("$SERVICECTLS" "getValidator_$1")" || {
            echo "Failed to get Validator Node $1 Public Key" >&2
            return 27
        }
        echo "$VALPUB" | grep -Eq '^0x[0-9a-fA-F]{64}$' || {
            echo "Invalid Validator Node $1 Public Key: $VALPUB" >&2
            return 28
        }
        VALPUBS+=("$VALPUB")
    }
    local COUNT="${ROLLOUT_VALIDATOR_CREATE_NUMBER:-1}"
    sequence createValidator $(seq $COUNT)
    [ ${#VALPUBS} -gt 0 ] || {
        echo "Invalid Validator Public Key: $VALPUB" >&2
        return 26
    }
    local VALPUBS="$(IFS=$'\n'; echo "${VALPUBS[*]}")"
    echo "$VALPUBS" > 'validator.pub' && {
        echo "Your Validator Public Key is saved to file: $(pwd)/validator.pub"
    } || {
        echo "Failed to write Validator Public Key to file" >&2
    }
    echo "Your validator Public Key:"
    echo "$VALPUBS" | sed 's/^/    /'
}

_cmd_install_service() {
    command -v systemctl &>/dev/null && {
        obey install_service_systemd
        return $?
    }
    echo "Failed to detect system service" >&2
    return 1
}

_cmd_install_service_systemd() {
    [ "$(id -u)" = "0" ] || {
        [ -z "$CENTOS7INSTALLSUBSHELL" ] || {
            echo "Failed to run install_service_systemd as superuser" >&2
            return 1
        }
        export CENTOS7INSTALLSUBSHELL=$$
        su "$SERVICENAME" -s "$0" install_service_systemd "$@" || {
            echo "Failed to run install_service_systemd" >&2
            return 2
        }
        return 0
    }
    [ -f "/etc/systemd/system/etherus.target" ] || getFile "$(pwd)/config/systemd" "etherus.target" > "/etc/systemd/system/etherus.target" || {
        echo "Failed to add etherus target to systemd" >&2
        return 10
    }
    [ -f "/etc/systemd/system/etherus@.service" ] || getFile "$(pwd)/config/systemd" "etherus@.service" > "/etc/systemd/system/etherus@.service" || {
        echo "Failed to add etherus service to systemd" >&2
        return 11
    }
    [ -f "/etc/systemd/system/tenderus@.service" ] || getFile "$(pwd)/config/systemd" "tenderus@.service" > "/etc/systemd/system/tenderus@.service" || {
        echo "Failed to add tenderus service to systemd" >&2
        return 12
    }
    systemctl daemon-reload || {
        echo "Failed to reload systemd daemon" >&2
        return 13
    }
    local WARNINGS=()
    local INSTALLS=0
    addDependency() {
        local OUT;
        OUT+="$(systemctl add-requires "etherus.target" "etherus@$1" 2>&1)" && {
            ((INSTALLS+=1))
        } || {
            OUT+="; $(echo "Requires=etherus@$1.service" >> '/etc/systemd/system/etherus.target')" && {
                ((INSTALLS+=1))
            } || {
                WARNINGS+=("Failed to add etherus $1 service to target: $OUT")
            }
        }
    }
    sequence addDependency $( ETHERCTLRUNPATH="$SERVICEPATH" "$SERVICECTLS" "listall" ) || {
        echo "Failed to add dependencies to target" >&2
        return 14
    }
    [ ${#WARNINGS[@]} -gt 0 ] && {
        echo "Dependencies are not added to etherus:" >&2
        (IFS=$'\n'; echo "${WARNINGS[*]}") >&2
        return 15
    }
    [ ${INSTALLS:-0} -gt 0 ] || {
        echo "No dependencies were added to etherus target" >&2
        return 16
    }
    systemctl daemon-reload || {
        echo "Failed to reload systemd daemon" >&2
        return 13
    }
    systemctl enable etherus.target && {
        echo "Etherus Daemon enabled successfully"
    } || {
        echo "Failed to enable Etherus Daemon" >&2
    }
    systemctl start etherus.target && {
        echo "Etherus Daemon started successfully"
    } || {
        echo "Failed to start Etherus Daemon" >&2
    }
    echo "Use systemctl for administration"
    systemctl list-dependencies etherus.target
}

_cmd_firewall() {
    command -v firewall-cmd &>/dev/null && {
        obey firewall_firewalld
        return $?
    }
    echo "Failed to detect system firewall" >&2
    return 1
}

_cmd_firewall_firewalld() {
    [ "$(id -u)" = "0" ] || {
        [ -z "$CENTOS7INSTALLSUBSHELL" ] || {
            echo "Failed to run firewall_firewalld as superuser" >&2
            return 1
        }
        export CENTOS7INSTALLSUBSHELL=$$
        su "$SERVICENAME" -s "$0" firewall_firewalld "$@" || {
            echo "Failed to run firewall_firewalld" >&2
            return 2
        }
        return 0
    }
    firewall-cmd --permanent --add-port=6656/tcp --add-port=6657/tcp --add-port=6660/tcp >/dev/null || {
        echo "Failed to configure etherus ports" >&2
        return 10
    }
    firewall-cmd --add-port=6656/tcp --add-port=6657/tcp --add-port=6660/tcp >/dev/null || {
        echo "Failed to open etherus ports" >&2
        return 11
    }
    echo "Firewall successfully configured for Etherus"
}

###################################################################################################

obey() {
    [ $# -eq 0 ] || {
        COMMAND="$1"
        shift
    }
    declare -F "_cmd_$COMMAND"&>/dev/null || {
        echo "Unknown command: $COMMAND"
        return -1
    }
    "_cmd_$COMMAND" "$@"
}

sequence() {
    local COMMAND="$1"
    shift
    for i in $@
    do
        $"$COMMAND" $i
    done
}

getFile() {
    [ $# -gt 1 ] && {
        local FILEPATH=$1
        shift
    }
    case "$1" in
        "genesis.json") [ -f "$FILEPATH/$1" ] && cat "$FILEPATH/$1" || cat << "#EOF#"
{
  "genesis_time": "2019-02-25T16:29:48.8917618Z",
  "chain_id": "etherus-main-chain",
  "consensus_params": {
    "block_size_params": {
      "max_bytes": "22020096",
      "max_txs": "10000",
      "max_gas": "-1"
  },
  "tx_size_params": {
      "max_bytes": "2097152",
      "max_gas": "-1"
  },
  "block_gossip_params": {
      "block_part_size_bytes": "65536"
  },
  "evidence_params": {
      "max_age": "100000"
  }
},
"validators": [
{
  "pub_key": {
    "type": "tendermint/PubKeyEd25519",
    "value": "zJMPdIPW9C1zghWHpEBhrgomU66dhDzD5VA3cGE8RXM="
},
"power": "2500",
"name": ""
}
],
"app_hash": ""
}
#EOF#
;;
"etherctl") cat << "#EOF#"
#!/usr/bin/env sh
#
# Copyright (C) 2019 Anton Filatov <ya-enot@mail.ru>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.
#
eval "$(base64 -d <<< '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' | gunzip)"
#EOF#
;;
"etherus.target") cat << "#EOF#"
[Install]
WantedBy=multi-user.target

[Unit]
Description=Etherus blockchain network
After=network.target
Requires=network.target
#EOF#
;;
"etherus@.service") cat << "#EOF#"
[Unit]
Description=Etherus service %i
PartOf=etherus.target
After=network.target
Requires=network.target
Requires=tenderus@%i.service

[Service]
User=etherus
Group=etherus
Type=forking
WorkingDirectory=/opt/etherus
OOMScoreAdjust=-999
ExecStart=/opt/etherus/etherctl start_%i_etherus
TimeoutStartSec=120
Restart=always

[Install]
WantedBy=etherus.target
#EOF#
;;
"tenderus@.service") cat << "#EOF#"
[Unit]
Description=Tenderus service %i
PartOf=etherus.target
After=network.target
Requires=network.target

[Service]
User=etherus
Group=etherus
Type=forking
WorkingDirectory=/opt/etherus
OOMScoreAdjust=-999
ExecStart=/opt/etherus/etherctl start_%i_tenderus
TimeoutStartSec=120
Restart=always

[Install]
WantedBy=etherus.target
#EOF#
;;
*) cat "$FILEPATH/$1"
;;
esac
}

obey "$@"
