#!/usr/bin/env sh
#
# Copyright (C) 2019 Anton Filatov <ya-enot@mail.ru>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.
#

SERVICENAME='etherus'
SERVICEPATH='/opt/etherus'
SERVICECTLS="$SERVICEPATH/etherctl"

###################################################################################################

_cmd_() {
    obey install
}

_cmd_install() {
    obey version && \
    obey synctime || {
        local EXIT=$?
        echo "Failed to synchronise time. Please do it manually then try again."
        return $EXIT
    } && \
    obey init && \
    obey rollout "$@" && \
    echo "Etherus installed successfully" || {
        local EXIT=$?
        echo "Etherus installation failed"
        return $EXIT
    }
    obey firewall || {
        echo "Firewall was not configured"
        echo "Please open ports 6656/tcp, 6657/tcp and 6660/tcp manually..."
    }
    obey install_service || {
        echo "Etherus daemon was not installed"
    }
}

_cmd_version() {
    echo "Etherus install script v0.1.7"
}

_cmd_synctime() {
    _synctime_check_ntpenabled || {
        echo "Precise time is required by Etherus" >&2
        echo "Please check the time synchronization consistency" >&2
        _synctime_check_ntpsynced
    }
}

_synctime_check_ntpenabled() {
    local NTPENABLED;
    NTPENABLED="$( (timedatectl | grep 'NTP enabled:' | sed 's/.*: \(.*\)/\1/') 2>&1 )" && {
        case "$NTPENABLED" in
            [Yy]* ) echo "Time synchronization enabled"
            ;;
            [Nn]* ) echo "Time synchronization disabled" >&2
            return 1
            ;;
            * ) echo "Time synchronization is: $NTPENABLED" >&2
            return 2
        esac
    } || {
        echo "Failed to detect time synchronization: $NTPENABLED" >&2
        return 3
    }
}

_synctime_check_ntpsynced() {
    local NTPSYNCED;
    NTPSYNCED="$( (timedatectl | grep 'NTP synchronized:' | sed 's/.*: \(.*\)/\1/') 2>&1 )" && {
        case "$NTPSYNCED" in
            [Yy]* ) echo "Time synchronized"
            ;;
            [Nn]* ) echo "Time not synchronized" >&2
            return 1
            ;;
            * ) echo "Time synchronization state is: $NTPSYNCED" >&2
            return 2
        esac
    } || {
        echo "Failed to detect time synchronization state: $NTPSYNCED" >&2
        return 3
    }
}

_cmd_init() {
    id -u "$SERVICENAME" &>/dev/null || {
        useradd -d "$SERVICEPATH" -r -s /bin/false "$SERVICENAME" || {
            echo "Failed to create service user: $SERVICENAME" >&2
            return 1
        }
    }

    [ -d "$SERVICEPATH/" ] || {
        mkdir -m 750 -p "$SERVICEPATH/" || {
            echo "Failed to create service directory: $SERVICEPATH" >&2
            return 2
        }
        chown -R "$SERVICENAME:$SERVICENAME" "$SERVICEPATH/" || {
            echo "Failed to change service directory owner: $SERVICEPATH" >&2
            return 3
        }
    }

    [ -d "$SERVICEPATH/bin" ] || {
        mkdir -m 750 -p "$SERVICEPATH/bin" || {
            echo "Failed to create binaries directory: $SERVICEPATH" >&2
            return 4
        }
        chown -R "$SERVICENAME:$SERVICENAME" "$SERVICEPATH/bin" || {
            echo "Failed to change binaries directory owner: $SERVICEPATH" >&2
            return 5
        }
    }

    [ -x "$SERVICECTLS" ] && [ "$(cat "$SERVICECTLS" | md5sum)" = "$(getFile 'etherctl' | md5sum)" ] || {
        touch "$SERVICECTLS" && \
        chmod 755 "$SERVICECTLS" && \
        getFile 'etherctl' > "$SERVICECTLS" || {
            echo "Failed to download service control script" >&2
            return 6
        }
    }
}

_args_rollout() {
    local ARGNAME
    while [ $# -gt 0 ]
    do
        case "$1" in
        -vpk|--validator-private-key)
            ARGNAME="ROLLOUT_VALIDATOR_PRIVATE_KEY"
            ;;
        -vcn|--validator-create-number)
            ARGNAME="ROLLOUT_VALIDATOR_CREATE_NUMBER"
            ;;
        *)
            [ "$ARGNAME" = "" ] && {
                echo "Invalid parameter: $1" >&2
                return 1
            }
            case "$ARGNAME" in
            ROLLOUT_VALIDATOR_PRIVATE_KEY)
                ROLLOUT_VALIDATOR_PRIVATE_KEY+=("$1")
                ;;
            ROLLOUT_VALIDATOR_CREATE_NUMBER)
                ROLLOUT_VALIDATOR_CREATE_NUMBER=$(($1))
                ;;
            *)
                return 2
            esac
        esac
        shift # next parameter
    done
}

_cmd_rollout() {
    [ "$(id -u)" = "$(id -u "$SERVICENAME")" ] || {
        [ -z "$CENTOS7INSTALLSUBSHELL" ] || {
            echo "Failed to run rollout as $SERVICENAME" >&2
            return 1
        }
        export CENTOS7INSTALLSUBSHELL=$$
        su "$SERVICENAME" -s "$(command -v sh || command -v bash)" -c "$0 rollout $(echo "$@")" || {
            echo "Failed to run rollout" >&2
            return 2
        }
        return 0
    }
    _args_rollout "$@" || {
        local EXITCODE=$?
        echo "Failed to parse arguments for rollout: $@" >&2
        return $EXITCODE
    }
    [ -d "$SERVICEPATH/" ] && cd "$SERVICEPATH/" || {
        echo "Unable to access service directory: $SERVICEPATH" >&2
        return 3
    }
    ( PEERS="07e21d35df9ff6ecce28a5f494d95b990da305bc@master.etherus.org:6656" "$SERVICECTLS" "new" ) || {
        echo "Sentry Node creation failed" >&2
        return 10
    }
    getFile "$(pwd)/config" "genesis.json" > "$("$SERVICECTLS" "path")/data/tenderus/config/genesis.json" || {
        echo "Failed to write Etherus genesis to Sentry Node" >&2
        return 11
    }
    local SNID="$("$SERVICECTLS" "getNodeId")" || {
        echo "Failed to get Sentry Node ID" >&2
        return 12
    }
    echo "$SNID" | grep -Eq '^[0-9a-fA-F]{40}$' || {
        echo "Invalid Sentry Node ID: $SNID" >&2
        return 13
    }
    local VALPUBS=()
    createValidator() {
        local NODEPATH="$("$SERVICECTLS" "path_$1")"
        [ -d "$NODEPATH/data/tenderus/config" ] && {
            echo "Validator Node $1 already exists" >&2
            return 20
        }
        mkdir -p "$NODEPATH/data/tenderus/config" || {
            echo "Validator Node $1 preparation failed" >&2
            return 21
        }
        getFile "$(pwd)/config" "genesis.json" > "$NODEPATH/data/tenderus/config/genesis.json" || {
            echo "Failed to write Etherus genesis to Validator Node" >&2
            return 22
        }
        [ $(($1)) -gt 0 ] && [ "${ROLLOUT_VALIDATOR_PRIVATE_KEY[$(($1-1))]}" != "" ] && {
            local PRIVATE_KEY="${ROLLOUT_VALIDATOR_PRIVATE_KEY[$(($1-1))]}"
            PRIVATE_KEY="$(
                case "$PRIVATE_KEY" in
                H4sI*)
                    DECODE() { 
                        base64 -d | gunzip
                    }
                    ;;
                \{*)
                    DECODE() { 
                        cat
                    }
                    ;;
                *)
                    DECODE() { 
                        base64 -d
                    }
                esac
                ( echo "$PRIVATE_KEY" | DECODE ) 2>/dev/null
            )" && [ ! -z "$PRIVATE_KEY" ] && { #"
                echo "Using specified private key $(echo "$PRIVATE_KEY" | md5sum | sed 's/\([0-9a-fA-F]\+\).*/\1/g')"
                echo "$PRIVATE_KEY" > "$NODEPATH/data/tenderus/config/priv_validator.json"
            } || {
                echo "Failed to set private key for Validator Node $1. Using autogenerated..." >&2
            }
        }
        ( PEERS="$SNID@127.0.0.1:6656" "$SERVICECTLS" "new_$1_private" ) || {
            echo "Validator Node $1 creation failed" >&2
            return 23
        }
        local VNID="$("$SERVICECTLS" "getNodeId_$1")" || {
            echo "Failed to get Validator Node $1 ID" >&2
            return 24
        }
        echo "$VNID" | grep -Eq '^[0-9a-fA-F]{40}$' || {
            echo "Invalid Validator Node $1 ID: $VNID" >&2
            return 25
        }
        "$SERVICECTLS" "addPrivatePeer $VNID" || {
            echo "Failed to add Validator Node $1 as peer to Sentry Node" >&2
            return 26
        }
        local VALPUB="$("$SERVICECTLS" "getValidator_$1")" || {
            echo "Failed to get Validator Node $1 Public Key" >&2
            return 27
        }
        echo "$VALPUB" | grep -Eq '^0x[0-9a-fA-F]{64}$' || {
            echo "Invalid Validator Node $1 Public Key: $VALPUB" >&2
            return 28
        }
        VALPUBS+=("$VALPUB")
    }
    local COUNT="${ROLLOUT_VALIDATOR_CREATE_NUMBER:-1}"
    sequence createValidator $(seq $COUNT)
    [ ${#VALPUBS} -gt 0 ] || {
        echo "Invalid Validator Public Key: $VALPUB" >&2
        return 26
    }
    local VALPUBS="$(IFS=$'\n'; echo "${VALPUBS[*]}")"
    echo "$VALPUBS" > 'validator.pub' && {
        echo "Your Validator Public Key is saved to file: $(pwd)/validator.pub"
    } || {
        echo "Failed to write Validator Public Key to file" >&2
    }
    echo "Your validator Public Key:"
    echo "$VALPUBS" | sed 's/^/    /'
}

_cmd_install_service() {
    command -v systemctl &>/dev/null && {
        obey install_service_systemd
        return $?
    }
    echo "Failed to detect system service" >&2
    return 1
}

_cmd_install_service_systemd() {
    [ "$(id -u)" = "0" ] || {
        [ -z "$CENTOS7INSTALLSUBSHELL" ] || {
            echo "Failed to run install_service_systemd as superuser" >&2
            return 1
        }
        export CENTOS7INSTALLSUBSHELL=$$
        su "$SERVICENAME" -s "$0" install_service_systemd "$@" || {
            echo "Failed to run install_service_systemd" >&2
            return 2
        }
        return 0
    }
    [ -f "/etc/systemd/system/etherus.target" ] || getFile "$(pwd)/config/systemd" "etherus.target" > "/etc/systemd/system/etherus.target" || {
        echo "Failed to add etherus target to systemd" >&2
        return 10
    }
    [ -f "/etc/systemd/system/etherus@.service" ] || getFile "$(pwd)/config/systemd" "etherus@.service" > "/etc/systemd/system/etherus@.service" || {
        echo "Failed to add etherus service to systemd" >&2
        return 11
    }
    [ -f "/etc/systemd/system/tenderus@.service" ] || getFile "$(pwd)/config/systemd" "tenderus@.service" > "/etc/systemd/system/tenderus@.service" || {
        echo "Failed to add tenderus service to systemd" >&2
        return 12
    }
    systemctl daemon-reload || {
        echo "Failed to reload systemd daemon" >&2
        return 13
    }
    local WARNINGS=()
    local INSTALLS=0
    addDependency() {
        local OUT;
        OUT+="$(systemctl add-requires "etherus.target" "etherus@$1" 2>&1)" && {
            ((INSTALLS+=1))
        } || {
            OUT+="; $(echo "Requires=etherus@$1.service" >> '/etc/systemd/system/etherus.target')" && {
                ((INSTALLS+=1))
            } || {
                WARNINGS+=("Failed to add etherus $1 service to target: $OUT")
            }
        }
    }
    sequence addDependency $( ETHERCTLRUNPATH="$SERVICEPATH" "$SERVICECTLS" "listall" ) || {
        echo "Failed to add dependencies to target" >&2
        return 14
    }
    [ ${#WARNINGS[@]} -gt 0 ] && {
        echo "Dependencies are not added to etherus:" >&2
        (IFS=$'\n'; echo "${WARNINGS[*]}") >&2
        return 15
    }
    [ ${INSTALLS:-0} -gt 0 ] || {
        echo "No dependencies were added to etherus target" >&2
        return 16
    }
    systemctl daemon-reload || {
        echo "Failed to reload systemd daemon" >&2
        return 13
    }
    systemctl enable etherus.target && {
        echo "Etherus Daemon enabled successfully"
    } || {
        echo "Failed to enable Etherus Daemon" >&2
    }
    systemctl start etherus.target && {
        echo "Etherus Daemon started successfully"
    } || {
        echo "Failed to start Etherus Daemon" >&2
    }
    echo "Use systemctl for administration"
    systemctl list-dependencies etherus.target
}

_cmd_firewall() {
    command -v firewall-cmd &>/dev/null && {
        obey firewall_firewalld
        return $?
    }
    echo "Failed to detect system firewall" >&2
    return 1
}

_cmd_firewall_firewalld() {
    [ "$(id -u)" = "0" ] || {
        [ -z "$CENTOS7INSTALLSUBSHELL" ] || {
            echo "Failed to run firewall_firewalld as superuser" >&2
            return 1
        }
        export CENTOS7INSTALLSUBSHELL=$$
        su "$SERVICENAME" -s "$0" firewall_firewalld "$@" || {
            echo "Failed to run firewall_firewalld" >&2
            return 2
        }
        return 0
    }
    firewall-cmd --permanent --add-port=6656/tcp --add-port=6657/tcp --add-port=6660/tcp >/dev/null || {
        echo "Failed to configure etherus ports" >&2
        return 10
    }
    firewall-cmd --add-port=6656/tcp --add-port=6657/tcp --add-port=6660/tcp >/dev/null || {
        echo "Failed to open etherus ports" >&2
        return 11
    }
    echo "Firewall successfully configured for Etherus"
}

###################################################################################################

obey() {
    [ $# -eq 0 ] || {
        COMMAND="$1"
        shift
    }
    declare -F "_cmd_$COMMAND"&>/dev/null || {
        echo "Unknown command: $COMMAND"
        return -1
    }
    "_cmd_$COMMAND" "$@"
}

sequence() {
    local COMMAND="$1"
    shift
    for i in $@
    do
        $"$COMMAND" $i
    done
}

getFile() {
    [ $# -gt 1 ] && {
        local FILEPATH=$1
        shift
    }
    case "$1" in
        "genesis.json") [ -f "$FILEPATH/$1" ] && cat "$FILEPATH/$1" || cat << "#EOF#"
{
  "genesis_time": "2019-02-25T16:29:48.8917618Z",
  "chain_id": "etherus-main-chain",
  "consensus_params": {
    "block_size_params": {
      "max_bytes": "22020096",
      "max_txs": "10000",
      "max_gas": "-1"
  },
  "tx_size_params": {
      "max_bytes": "2097152",
      "max_gas": "-1"
  },
  "block_gossip_params": {
      "block_part_size_bytes": "65536"
  },
  "evidence_params": {
      "max_age": "100000"
  }
},
"validators": [
{
  "pub_key": {
    "type": "tendermint/PubKeyEd25519",
    "value": "zJMPdIPW9C1zghWHpEBhrgomU66dhDzD5VA3cGE8RXM="
},
"power": "2500",
"name": ""
}
],
"app_hash": ""
}
#EOF#
;;
"etherctl") cat << "#EOF#"
#!/usr/bin/env sh
#
# Copyright (C) 2019 Anton Filatov <ya-enot@mail.ru>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.
#
eval "$(base64 -d <<< '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' | gunzip)"
#EOF#
;;
"etherus.target") cat << "#EOF#"
[Install]
WantedBy=multi-user.target

[Unit]
Description=Etherus blockchain network
After=network.target
Requires=network.target
#EOF#
;;
"etherus@.service") cat << "#EOF#"
[Unit]
Description=Etherus service %i
PartOf=etherus.target
After=network.target
Requires=network.target
Requires=tenderus@%i.service

[Service]
User=etherus
Group=etherus
Type=forking
WorkingDirectory=/opt/etherus
OOMScoreAdjust=-999
ExecStart=/opt/etherus/etherctl start_%i_etherus
TimeoutStartSec=120
Restart=always

[Install]
WantedBy=etherus.target
#EOF#
;;
"tenderus@.service") cat << "#EOF#"
[Unit]
Description=Tenderus service %i
PartOf=etherus.target
After=network.target
Requires=network.target

[Service]
User=etherus
Group=etherus
Type=forking
WorkingDirectory=/opt/etherus
OOMScoreAdjust=-999
ExecStart=/opt/etherus/etherctl start_%i_tenderus
TimeoutStartSec=120
Restart=always

[Install]
WantedBy=etherus.target
#EOF#
;;
*) cat "$FILEPATH/$1"
;;
esac
}

obey "$@"
