#!/usr/bin/env sh
#
# Copyright (C) 2019 Anton Filatov <ya-enot@mail.ru>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.
#

SERVICENAME='etherus'
SERVICEPATH='/opt/etherus'
SERVICECTLS="$SERVICEPATH/etherctl"

###################################################################################################

_cmd_() {
    obey install
}

_cmd_install() {
    obey version && \
    obey synctime || {
        local EXIT=$?
        echo "Failed to synchronise time. Please do it manually then try again."
        return $EXIT
    } && \
    obey init && \
    obey rollout "$@" && \
    echo "Etherus installed successfully" || {
        local EXIT=$?
        echo "Etherus installation failed"
        return $EXIT
    }
    obey firewall || {
        echo "Firewall was not configured"
        echo "Please open ports 6656/tcp, 6657/tcp and 6660/tcp manually..."
    }
    obey install_service || {
        echo "Etherus daemon was not installed"
    }
}

_cmd_version() {
    echo "Etherus install script v0.1.7"
}

_cmd_synctime() {
    _synctime_check_ntpenabled || {
        echo "Precise time is required by Etherus" >&2
        echo "Please check the time synchronization consistency" >&2
        _synctime_check_ntpsynced
    }
}

_synctime_check_ntpenabled() {
    local NTPENABLED;
    NTPENABLED="$( (timedatectl | grep 'NTP enabled:' | sed 's/.*: \(.*\)/\1/') 2>&1 )" && {
        case "$NTPENABLED" in
            [Yy]* ) echo "Time synchronization enabled"
            ;;
            [Nn]* ) echo "Time synchronization disabled" >&2
            return 1
            ;;
            * ) echo "Time synchronization is: $NTPENABLED" >&2
            return 2
        esac
    } || {
        echo "Failed to detect time synchronization: $NTPENABLED" >&2
        return 3
    }
}

_synctime_check_ntpsynced() {
    local NTPSYNCED;
    NTPSYNCED="$( (timedatectl | grep 'NTP synchronized:' | sed 's/.*: \(.*\)/\1/') 2>&1 )" && {
        case "$NTPSYNCED" in
            [Yy]* ) echo "Time synchronized"
            ;;
            [Nn]* ) echo "Time not synchronized" >&2
            return 1
            ;;
            * ) echo "Time synchronization state is: $NTPSYNCED" >&2
            return 2
        esac
    } || {
        echo "Failed to detect time synchronization state: $NTPSYNCED" >&2
        return 3
    }
}

_cmd_init() {
    id -u "$SERVICENAME" &>/dev/null || {
        useradd -d "$SERVICEPATH" -r -s /bin/false "$SERVICENAME" || {
            echo "Failed to create service user: $SERVICENAME" >&2
            return 1
        }
    }

    [ -d "$SERVICEPATH/" ] || {
        mkdir -m 750 -p "$SERVICEPATH/" || {
            echo "Failed to create service directory: $SERVICEPATH" >&2
            return 2
        }
        chown -R "$SERVICENAME:$SERVICENAME" "$SERVICEPATH/" || {
            echo "Failed to change service directory owner: $SERVICEPATH" >&2
            return 3
        }
    }

    [ -d "$SERVICEPATH/bin" ] || {
        mkdir -m 750 -p "$SERVICEPATH/bin" || {
            echo "Failed to create binaries directory: $SERVICEPATH" >&2
            return 4
        }
        chown -R "$SERVICENAME:$SERVICENAME" "$SERVICEPATH/bin" || {
            echo "Failed to change binaries directory owner: $SERVICEPATH" >&2
            return 5
        }
    }

    [ -x "$SERVICECTLS" ] && [ "$(cat "$SERVICECTLS" | md5sum)" = "$(getFile 'etherctl' | md5sum)" ] || {
        touch "$SERVICECTLS" && \
        chmod 755 "$SERVICECTLS" && \
        getFile 'etherctl' > "$SERVICECTLS" || {
            echo "Failed to download service control script" >&2
            return 6
        }
    }
}

_args_rollout() {
    local ARGNAME
    while [ $# -gt 0 ]
    do
        case "$1" in
        -vpk|--validator-private-key)
            ARGNAME="ROLLOUT_VALIDATOR_PRIVATE_KEY"
            ;;
        -vcn|--validator-create-number)
            ARGNAME="ROLLOUT_VALIDATOR_CREATE_NUMBER"
            ;;
        *)
            [ "$ARGNAME" = "" ] && {
                echo "Invalid parameter: $1" >&2
                return 1
            }
            case "$ARGNAME" in
            ROLLOUT_VALIDATOR_PRIVATE_KEY)
                ROLLOUT_VALIDATOR_PRIVATE_KEY+=("$1")
                ;;
            ROLLOUT_VALIDATOR_CREATE_NUMBER)
                ROLLOUT_VALIDATOR_CREATE_NUMBER=$(($1))
                ;;
            *)
                return 2
            esac
        esac
        shift # next parameter
    done
}

_cmd_rollout() {
    [ "$(id -u)" = "$(id -u "$SERVICENAME")" ] || {
        [ -z "$CENTOS7INSTALLSUBSHELL" ] || {
            echo "Failed to run rollout as $SERVICENAME" >&2
            return 1
        }
        export CENTOS7INSTALLSUBSHELL=$$
        su "$SERVICENAME" -s "$(command -v sh || command -v bash)" -c "$0 rollout $(echo "$@")" || {
            echo "Failed to run rollout" >&2
            return 2
        }
        return 0
    }
    _args_rollout "$@" || {
        local EXITCODE=$?
        echo "Failed to parse arguments for rollout: $@" >&2
        return $EXITCODE
    }
    [ -d "$SERVICEPATH/" ] && cd "$SERVICEPATH/" || {
        echo "Unable to access service directory: $SERVICEPATH" >&2
        return 3
    }
    env PEERS="07e21d35df9ff6ecce28a5f494d95b990da305bc@master.etherus.org:6656" "$SERVICECTLS" "new" || {
        echo "Sentry Node creation failed" >&2
        return 10
    }
    getFile "$(pwd)/config" "genesis.json" > "$("$SERVICECTLS" "path")/data/tenderus/config/genesis.json" || {
        echo "Failed to write Etherus genesis to Sentry Node" >&2
        return 11
    }
    local SNID="$("$SERVICECTLS" "getNodeId")" || {
        echo "Failed to get Sentry Node ID" >&2
        return 12
    }
    echo "$SNID" | grep -Eq '^[0-9a-fA-F]{40}$' || {
        echo "Invalid Sentry Node ID: $SNID" >&2
        return 13
    }
    local VALPUBS=()
    createValidator() {
        local NODEPATH="$("$SERVICECTLS" "path_$1")"
        [ -d "$NODEPATH/data/tenderus/config" ] && {
            echo "Validator Node $1 already exists" >&2
            return 20
        }
        mkdir -p "$NODEPATH/data/tenderus/config" || {
            echo "Validator Node $1 preparation failed" >&2
            return 21
        }
        getFile "$(pwd)/config" "genesis.json" > "$NODEPATH/data/tenderus/config/genesis.json" || {
            echo "Failed to write Etherus genesis to Validator Node" >&2
            return 22
        }
        [ $(($1)) -gt 0 ] && [ "${ROLLOUT_VALIDATOR_PRIVATE_KEY[$(($1-1))]}" != "" ] && {
            local PRIVATE_KEY="${ROLLOUT_VALIDATOR_PRIVATE_KEY[$(($1-1))]}"
            PRIVATE_KEY="$(
                case "$PRIVATE_KEY" in
                H4sI*)
                    DECODE() { 
                        base64 -d | gunzip
                    }
                    ;;
                \{*)
                    DECODE() { 
                        cat
                    }
                    ;;
                *)
                    DECODE() { 
                        base64 -d
                    }
                esac
                ( echo "$PRIVATE_KEY" | DECODE ) 2>/dev/null
            )" && [ ! -z "$PRIVATE_KEY" ] && { #"
                echo "Using specified private key $(echo "$PRIVATE_KEY" | md5sum | sed 's/\([0-9a-fA-F]\+\).*/\1/g')"
                echo "$PRIVATE_KEY" > "$NODEPATH/data/tenderus/config/priv_validator.json"
            } || {
                echo "Failed to set private key for Validator Node $1. Using autogenerated..." >&2
            }
        }
        env PEERS="$SNID@127.0.0.1:6656" "$SERVICECTLS" "new_$1_private" || {
            echo "Validator Node $1 creation failed" >&2
            return 23
        }
        local VNID="$("$SERVICECTLS" "getNodeId_$1")" || {
            echo "Failed to get Validator Node $1 ID" >&2
            return 24
        }
        echo "$VNID" | grep -Eq '^[0-9a-fA-F]{40}$' || {
            echo "Invalid Validator Node $1 ID: $VNID" >&2
            return 25
        }
        "$SERVICECTLS" "addPrivatePeer $VNID" || {
            echo "Failed to add Validator Node $1 as peer to Sentry Node" >&2
            return 26
        }
        local VALPUB="$("$SERVICECTLS" "getValidator_$1")" || {
            echo "Failed to get Validator Node $1 Public Key" >&2
            return 27
        }
        echo "$VALPUB" | grep -Eq '^0x[0-9a-fA-F]{64}$' || {
            echo "Invalid Validator Node $1 Public Key: $VALPUB" >&2
            return 28
        }
        VALPUBS+=("$VALPUB")
    }
    local COUNT="${ROLLOUT_VALIDATOR_CREATE_NUMBER:-1}"
    sequence createValidator $(seq $COUNT)
    [ ${#VALPUBS} -gt 0 ] || {
        echo "Invalid Validator Public Key: $VALPUB" >&2
        return 26
    }
    local VALPUBS="$(IFS=$'\n'; echo "${VALPUBS[*]}")"
    echo "$VALPUBS" > 'validator.pub' && {
        echo "Your Validator Public Key is saved to file: $(pwd)/validator.pub"
    } || {
        echo "Failed to write Validator Public Key to file" >&2
    }
    echo "Your validator Public Key:"
    echo "$VALPUBS" | sed 's/^/    /'
}

_cmd_install_service() {
    command -v systemctl &>/dev/null && {
        obey install_service_systemd
        return $?
    }
    echo "Failed to detect system service" >&2
    return 1
}

_cmd_install_service_systemd() {
    [ "$(id -u)" = "0" ] || {
        [ -z "$CENTOS7INSTALLSUBSHELL" ] || {
            echo "Failed to run install_service_systemd as superuser" >&2
            return 1
        }
        export CENTOS7INSTALLSUBSHELL=$$
        su "$SERVICENAME" -s "$0" install_service_systemd "$@" || {
            echo "Failed to run install_service_systemd" >&2
            return 2
        }
        return 0
    }
    [ -f "/etc/systemd/system/etherus.target" ] || getFile "$(pwd)/config/systemd" "etherus.target" > "/etc/systemd/system/etherus.target" || {
        echo "Failed to add etherus target to systemd" >&2
        return 10
    }
    [ -f "/etc/systemd/system/etherus@.service" ] || getFile "$(pwd)/config/systemd" "etherus@.service" > "/etc/systemd/system/etherus@.service" || {
        echo "Failed to add etherus service to systemd" >&2
        return 11
    }
    [ -f "/etc/systemd/system/tenderus@.service" ] || getFile "$(pwd)/config/systemd" "tenderus@.service" > "/etc/systemd/system/tenderus@.service" || {
        echo "Failed to add tenderus service to systemd" >&2
        return 12
    }
    systemctl daemon-reload || {
        echo "Failed to reload systemd daemon" >&2
        return 13
    }
    local WARNINGS=()
    local INSTALLS=0
    addDependency() {
        local OUT;
        OUT+="$(systemctl add-requires "etherus.target" "etherus@$1" 2>&1)" && {
            ((INSTALLS+=1))
        } || {
            OUT+="; $(echo "Requires=etherus@$1.service" >> '/etc/systemd/system/etherus.target')" && {
                ((INSTALLS+=1))
            } || {
                WARNINGS+=("Failed to add etherus $1 service to target: $OUT")
            }
        }
    }
    sequence addDependency $(env ETHERCTLRUNPATH="$SERVICEPATH" "$SERVICECTLS" "listall") || {
        echo "Failed to add dependencies to target" >&2
        return 14
    }
    [ ${#WARNINGS[@]} -gt 0 ] && {
        echo "Dependencies are not added to etherus:" >&2
        (IFS=$'\n'; echo "${WARNINGS[*]}") >&2
        return 15
    }
    [ ${INSTALLS:-0} -gt 0 ] || {
        echo "No dependencies were added to etherus target" >&2
        return 16
    }
    systemctl daemon-reload || {
        echo "Failed to reload systemd daemon" >&2
        return 13
    }
    systemctl enable etherus.target && {
        echo "Etherus Daemon enabled successfully"
    } || {
        echo "Failed to enable Etherus Daemon" >&2
    }
    systemctl start etherus.target && {
        echo "Etherus Daemon started successfully"
    } || {
        echo "Failed to start Etherus Daemon" >&2
    }
    echo "Use systemctl for administration"
    systemctl list-dependencies etherus.target
}

_cmd_firewall() {
    command -v firewall-cmd &>/dev/null && {
        obey firewall_firewalld
        return $?
    }
    echo "Failed to detect system firewall" >&2
    return 1
}

_cmd_firewall_firewalld() {
    [ "$(id -u)" = "0" ] || {
        [ -z "$CENTOS7INSTALLSUBSHELL" ] || {
            echo "Failed to run firewall_firewalld as superuser" >&2
            return 1
        }
        export CENTOS7INSTALLSUBSHELL=$$
        su "$SERVICENAME" -s "$0" firewall_firewalld "$@" || {
            echo "Failed to run firewall_firewalld" >&2
            return 2
        }
        return 0
    }
    firewall-cmd --permanent --add-port=6656/tcp --add-port=6657/tcp --add-port=6660/tcp >/dev/null || {
        echo "Failed to configure etherus ports" >&2
        return 10
    }
    firewall-cmd --add-port=6656/tcp --add-port=6657/tcp --add-port=6660/tcp >/dev/null || {
        echo "Failed to open etherus ports" >&2
        return 11
    }
    echo "Firewall successfully configured for Etherus"
}

###################################################################################################

obey() {
    [ $# -eq 0 ] || {
        COMMAND="$1"
        shift
    }
    declare -F "_cmd_$COMMAND"&>/dev/null || {
        echo "Unknown command: $COMMAND"
        return -1
    }
    "_cmd_$COMMAND" "$@"
}

sequence() {
    local COMMAND="$1"
    shift
    for i in $@
    do
        $"$COMMAND" $i
    done
}

getFile() {
    [ $# -gt 1 ] && {
        local FILEPATH=$1
        shift
    }
    case "$1" in
        "genesis.json") [ -f "$FILEPATH/$1" ] && cat "$FILEPATH/$1" || cat << "#EOF#"
{
  "genesis_time": "2019-02-25T16:29:48.8917618Z",
  "chain_id": "etherus-main-chain",
  "consensus_params": {
    "block_size_params": {
      "max_bytes": "22020096",
      "max_txs": "10000",
      "max_gas": "-1"
  },
  "tx_size_params": {
      "max_bytes": "2097152",
      "max_gas": "-1"
  },
  "block_gossip_params": {
      "block_part_size_bytes": "65536"
  },
  "evidence_params": {
      "max_age": "100000"
  }
},
"validators": [
{
  "pub_key": {
    "type": "tendermint/PubKeyEd25519",
    "value": "zJMPdIPW9C1zghWHpEBhrgomU66dhDzD5VA3cGE8RXM="
},
"power": "2500",
"name": ""
}
],
"app_hash": ""
}
#EOF#
;;
"etherctl") cat << "#EOF#"
#!/usr/bin/env sh
#
# Copyright (C) 2019 Anton Filatov <ya-enot@mail.ru>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.
#
eval "$(base64 -d <<< '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' | gunzip)"
#EOF#
;;
"etherus.target") cat << "#EOF#"
[Install]
WantedBy=multi-user.target

[Unit]
Description=Etherus blockchain network
After=network.target
Requires=network.target
#EOF#
;;
"etherus@.service") cat << "#EOF#"
[Unit]
Description=Etherus service %i
PartOf=etherus.target
After=network.target
Requires=network.target
Requires=tenderus@%i.service

[Service]
User=etherus
Group=etherus
Type=forking
WorkingDirectory=/opt/etherus
OOMScoreAdjust=-999
ExecStart=/opt/etherus/etherctl start_%i_etherus
TimeoutStartSec=120
Restart=always

[Install]
WantedBy=etherus.target
#EOF#
;;
"tenderus@.service") cat << "#EOF#"
[Unit]
Description=Tenderus service %i
PartOf=etherus.target
After=network.target
Requires=network.target

[Service]
User=etherus
Group=etherus
Type=forking
WorkingDirectory=/opt/etherus
OOMScoreAdjust=-999
ExecStart=/opt/etherus/etherctl start_%i_tenderus
TimeoutStartSec=120
Restart=always

[Install]
WantedBy=etherus.target
#EOF#
;;
*) cat "$FILEPATH/$1"
;;
esac
}

obey "$@"
