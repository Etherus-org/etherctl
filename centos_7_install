#!/usr/bin/env sh
#
# Copyright (C) 2019 Anton Filatov <ya-enot@mail.ru>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.
#

SERVICENAME='etherus'
SERVICEPATH='/opt/etherus'
SERVICECTLS="$SERVICEPATH/etherctl"

###################################################################################################

_cmd_() {
    obey install
}

_cmd_install() {
    obey version && \
    obey synctime || {
        local EXIT=$?
        echo "Failed to synchronise time. Please do it manually then try again."
        return $EXIT
    } && \
    obey init && \
    obey rollout "$@" && \
    echo "Etherus installed successfully" || {
        local EXIT=$?
        echo "Etherus installation failed"
        return $EXIT
    }
    obey firewall || {
        echo "Firewall was not configured"
        echo "Please open ports 6656/tcp, 6657/tcp and 6660/tcp manually..."
    }
    obey install_service || {
        echo "Etherus daemon was not installed"
    }
}

_cmd_version() {
    echo "Etherus install script v0.1.7"
}

_cmd_synctime() {
    _synctime_check_ntpenabled || {
        echo "Precise time is required by Etherus" >&2
        echo "Please check the time synchronization consistency" >&2
        _synctime_check_ntpsynced
    }
}

_synctime_check_ntpenabled() {
    local NTPENABLED;
    NTPENABLED="$( (timedatectl | grep 'NTP enabled:' | sed 's/.*: \(.*\)/\1/') 2>&1 )" && {
        case "$NTPENABLED" in
            [Yy]* ) echo "Time synchronization enabled"
            ;;
            [Nn]* ) echo "Time synchronization disabled" >&2
            return 1
            ;;
            * ) echo "Time synchronization is: $NTPENABLED" >&2
            return 2
        esac
    } || {
        echo "Failed to detect time synchronization: $NTPENABLED" >&2
        return 3
    }
}

_synctime_check_ntpsynced() {
    local NTPSYNCED;
    NTPSYNCED="$( (timedatectl | grep 'NTP synchronized:' | sed 's/.*: \(.*\)/\1/') 2>&1 )" && {
        case "$NTPSYNCED" in
            [Yy]* ) echo "Time synchronized"
            ;;
            [Nn]* ) echo "Time not synchronized" >&2
            return 1
            ;;
            * ) echo "Time synchronization state is: $NTPSYNCED" >&2
            return 2
        esac
    } || {
        echo "Failed to detect time synchronization state: $NTPSYNCED" >&2
        return 3
    }
}

_cmd_init() {
    id -u "$SERVICENAME" &>/dev/null || {
        useradd -d "$SERVICEPATH" -r -s /bin/false "$SERVICENAME" || {
            echo "Failed to create service user: $SERVICENAME" >&2
            return 1
        }
    }

    [ -d "$SERVICEPATH/" ] || {
        mkdir -m 750 -p "$SERVICEPATH/" || {
            echo "Failed to create service directory: $SERVICEPATH" >&2
            return 2
        }
        chown -R "$SERVICENAME:$SERVICENAME" "$SERVICEPATH/" || {
            echo "Failed to change service directory owner: $SERVICEPATH" >&2
            return 3
        }
    }

    [ -d "$SERVICEPATH/bin" ] || {
        mkdir -m 750 -p "$SERVICEPATH/bin" || {
            echo "Failed to create binaries directory: $SERVICEPATH" >&2
            return 4
        }
        chown -R "$SERVICENAME:$SERVICENAME" "$SERVICEPATH/bin" || {
            echo "Failed to change binaries directory owner: $SERVICEPATH" >&2
            return 5
        }
    }

    [ -x "$SERVICECTLS" ] && [ "$(cat "$SERVICECTLS" | md5sum)" = "$(getFile 'etherctl' | md5sum)" ] || {
        touch "$SERVICECTLS" && \
        chmod 755 "$SERVICECTLS" && \
        getFile 'etherctl' > "$SERVICECTLS" || {
            echo "Failed to download service control script" >&2
            return 6
        }
    }
}

_args_rollout() {
    local ARGNAME
    while [ $# -gt 0 ]
    do
        case "$1" in
        -vpk|--validator-private-key)
            ARGNAME="ROLLOUT_VALIDATOR_PRIVATE_KEY"
            ;;
        -vcn|--validator-create-number)
            ARGNAME="ROLLOUT_VALIDATOR_CREATE_NUMBER"
            ;;
        *)
            [ "$ARGNAME" = "" ] && {
                echo "Invalid parameter: $1" >&2
                return 1
            }
            case "$ARGNAME" in
            ROLLOUT_VALIDATOR_PRIVATE_KEY)
                ROLLOUT_VALIDATOR_PRIVATE_KEY+=("$1")
                ;;
            ROLLOUT_VALIDATOR_CREATE_NUMBER)
                ROLLOUT_VALIDATOR_CREATE_NUMBER=$(($1))
                ;;
            *)
                return 2
            esac
        esac
        shift # next parameter
    done
}

_cmd_rollout() {
    [ "$(id -u)" = "$(id -u "$SERVICENAME")" ] || {
        [ -z "$CENTOS7INSTALLSUBSHELL" ] || {
            echo "Failed to run rollout as $SERVICENAME" >&2
            return 1
        }
        export CENTOS7INSTALLSUBSHELL=$$
        su "$SERVICENAME" -s "$(command -v sh || command -v bash)" -c "$0 rollout $(echo "$@")" || {
            echo "Failed to run rollout" >&2
            return 2
        }
        return 0
    }
    _args_rollout "$@" || {
        local EXITCODE=$?
        echo "Failed to parse arguments for rollout: $@" >&2
        return $EXITCODE
    }
    [ -d "$SERVICEPATH/" ] && cd "$SERVICEPATH/" || {
        echo "Unable to access service directory: $SERVICEPATH" >&2
        return 3
    }
    ( PEERS="07e21d35df9ff6ecce28a5f494d95b990da305bc@master.etherus.org:6656" "$SERVICECTLS" "new" ) || {
        echo "Sentry Node creation failed" >&2
        return 10
    }
    getFile "$(pwd)/config" "genesis.json" > "$("$SERVICECTLS" "path")/data/tenderus/config/genesis.json" || {
        echo "Failed to write Etherus genesis to Sentry Node" >&2
        return 11
    }
    local SNID="$("$SERVICECTLS" "getNodeId")" || {
        echo "Failed to get Sentry Node ID" >&2
        return 12
    }
    echo "$SNID" | grep -Eq '^[0-9a-fA-F]{40}$' || {
        echo "Invalid Sentry Node ID: $SNID" >&2
        return 13
    }
    local VALPUBS=()
    createValidator() {
        local NODEPATH="$("$SERVICECTLS" "path_$1")"
        [ -d "$NODEPATH/data/tenderus/config" ] && {
            echo "Validator Node $1 already exists" >&2
            return 20
        }
        mkdir -p "$NODEPATH/data/tenderus/config" || {
            echo "Validator Node $1 preparation failed" >&2
            return 21
        }
        getFile "$(pwd)/config" "genesis.json" > "$NODEPATH/data/tenderus/config/genesis.json" || {
            echo "Failed to write Etherus genesis to Validator Node" >&2
            return 22
        }
        [ $(($1)) -gt 0 ] && [ "${ROLLOUT_VALIDATOR_PRIVATE_KEY[$(($1-1))]}" != "" ] && {
            local PRIVATE_KEY="${ROLLOUT_VALIDATOR_PRIVATE_KEY[$(($1-1))]}"
            PRIVATE_KEY="$(
                case "$PRIVATE_KEY" in
                H4sI*)
                    DECODE() { 
                        base64 -d | gunzip
                    }
                    ;;
                \{*)
                    DECODE() { 
                        cat
                    }
                    ;;
                *)
                    DECODE() { 
                        base64 -d
                    }
                esac
                ( echo "$PRIVATE_KEY" | DECODE ) 2>/dev/null
            )" && [ ! -z "$PRIVATE_KEY" ] && { #"
                echo "Using specified private key $(echo "$PRIVATE_KEY" | md5sum | sed 's/\([0-9a-fA-F]\+\).*/\1/g')"
                echo "$PRIVATE_KEY" > "$NODEPATH/data/tenderus/config/priv_validator.json"
            } || {
                echo "Failed to set private key for Validator Node $1. Using autogenerated..." >&2
            }
        }
        ( PEERS="$SNID@127.0.0.1:6656" "$SERVICECTLS" "new_$1_private" ) || {
            echo "Validator Node $1 creation failed" >&2
            return 23
        }
        local VNID="$("$SERVICECTLS" "getNodeId_$1")" || {
            echo "Failed to get Validator Node $1 ID" >&2
            return 24
        }
        echo "$VNID" | grep -Eq '^[0-9a-fA-F]{40}$' || {
            echo "Invalid Validator Node $1 ID: $VNID" >&2
            return 25
        }
        "$SERVICECTLS" "addPrivatePeer $VNID" || {
            echo "Failed to add Validator Node $1 as peer to Sentry Node" >&2
            return 26
        }
        local VALPUB="$("$SERVICECTLS" "getValidator_$1")" || {
            echo "Failed to get Validator Node $1 Public Key" >&2
            return 27
        }
        echo "$VALPUB" | grep -Eq '^0x[0-9a-fA-F]{64}$' || {
            echo "Invalid Validator Node $1 Public Key: $VALPUB" >&2
            return 28
        }
        VALPUBS+=("$VALPUB")
    }
    local COUNT="${ROLLOUT_VALIDATOR_CREATE_NUMBER:-1}"
    sequence createValidator $(seq $COUNT)
    [ ${#VALPUBS} -gt 0 ] || {
        echo "Invalid Validator Public Key: $VALPUB" >&2
        return 26
    }
    local VALPUBS="$(IFS=$'\n'; echo "${VALPUBS[*]}")"
    echo "$VALPUBS" > 'validator.pub' && {
        echo "Your Validator Public Key is saved to file: $(pwd)/validator.pub"
    } || {
        echo "Failed to write Validator Public Key to file" >&2
    }
    echo "Your validator Public Key:"
    echo "$VALPUBS" | sed 's/^/    /'
}

_cmd_install_service() {
    command -v systemctl &>/dev/null && {
        obey install_service_systemd
        return $?
    }
    echo "Failed to detect system service" >&2
    return 1
}

_cmd_install_service_systemd() {
    [ "$(id -u)" = "0" ] || {
        [ -z "$CENTOS7INSTALLSUBSHELL" ] || {
            echo "Failed to run install_service_systemd as superuser" >&2
            return 1
        }
        export CENTOS7INSTALLSUBSHELL=$$
        su "$SERVICENAME" -s "$0" install_service_systemd "$@" || {
            echo "Failed to run install_service_systemd" >&2
            return 2
        }
        return 0
    }
    [ -f "/etc/systemd/system/etherus.target" ] || getFile "$(pwd)/config/systemd" "etherus.target" > "/etc/systemd/system/etherus.target" || {
        echo "Failed to add etherus target to systemd" >&2
        return 10
    }
    [ -f "/etc/systemd/system/etherus@.service" ] || getFile "$(pwd)/config/systemd" "etherus@.service" > "/etc/systemd/system/etherus@.service" || {
        echo "Failed to add etherus service to systemd" >&2
        return 11
    }
    [ -f "/etc/systemd/system/tenderus@.service" ] || getFile "$(pwd)/config/systemd" "tenderus@.service" > "/etc/systemd/system/tenderus@.service" || {
        echo "Failed to add tenderus service to systemd" >&2
        return 12
    }
    systemctl daemon-reload || {
        echo "Failed to reload systemd daemon" >&2
        return 13
    }
    local WARNINGS=()
    local INSTALLS=0
    addDependency() {
        local OUT;
        OUT+="$(systemctl add-requires "etherus.target" "etherus@$1" 2>&1)" && {
            ((INSTALLS+=1))
        } || {
            OUT+="; $(echo "Requires=etherus@$1.service" >> '/etc/systemd/system/etherus.target')" && {
                ((INSTALLS+=1))
            } || {
                WARNINGS+=("Failed to add etherus $1 service to target: $OUT")
            }
        }
    }
    sequence addDependency $( ETHERCTLRUNPATH="$SERVICEPATH" "$SERVICECTLS" "listall" ) || {
        echo "Failed to add dependencies to target" >&2
        return 14
    }
    [ ${#WARNINGS[@]} -gt 0 ] && {
        echo "Dependencies are not added to etherus:" >&2
        (IFS=$'\n'; echo "${WARNINGS[*]}") >&2
        return 15
    }
    [ ${INSTALLS:-0} -gt 0 ] || {
        echo "No dependencies were added to etherus target" >&2
        return 16
    }
    systemctl daemon-reload || {
        echo "Failed to reload systemd daemon" >&2
        return 13
    }
    systemctl enable etherus.target && {
        echo "Etherus Daemon enabled successfully"
    } || {
        echo "Failed to enable Etherus Daemon" >&2
    }
    systemctl start etherus.target && {
        echo "Etherus Daemon started successfully"
    } || {
        echo "Failed to start Etherus Daemon" >&2
    }
    echo "Use systemctl for administration"
    systemctl list-dependencies etherus.target
}

_cmd_firewall() {
    command -v firewall-cmd &>/dev/null && {
        obey firewall_firewalld
        return $?
    }
    echo "Failed to detect system firewall" >&2
    return 1
}

_cmd_firewall_firewalld() {
    [ "$(id -u)" = "0" ] || {
        [ -z "$CENTOS7INSTALLSUBSHELL" ] || {
            echo "Failed to run firewall_firewalld as superuser" >&2
            return 1
        }
        export CENTOS7INSTALLSUBSHELL=$$
        su "$SERVICENAME" -s "$0" firewall_firewalld "$@" || {
            echo "Failed to run firewall_firewalld" >&2
            return 2
        }
        return 0
    }
    firewall-cmd --permanent --add-port=6656/tcp --add-port=6657/tcp --add-port=6660/tcp >/dev/null || {
        echo "Failed to configure etherus ports" >&2
        return 10
    }
    firewall-cmd --add-port=6656/tcp --add-port=6657/tcp --add-port=6660/tcp >/dev/null || {
        echo "Failed to open etherus ports" >&2
        return 11
    }
    echo "Firewall successfully configured for Etherus"
}

###################################################################################################

obey() {
    [ $# -eq 0 ] || {
        COMMAND="$1"
        shift
    }
    declare -F "_cmd_$COMMAND"&>/dev/null || {
        echo "Unknown command: $COMMAND"
        return -1
    }
    "_cmd_$COMMAND" "$@"
}

sequence() {
    local COMMAND="$1"
    shift
    for i in $@
    do
        $"$COMMAND" $i
    done
}

getFile() {
    [ $# -gt 1 ] && {
        local FILEPATH=$1
        shift
    }
    case "$1" in
        "genesis.json") [ -f "$FILEPATH/$1" ] && cat "$FILEPATH/$1" || cat << "#EOF#"
{
  "genesis_time": "2019-02-25T16:29:48.8917618Z",
  "chain_id": "etherus-main-chain",
  "consensus_params": {
    "block_size_params": {
      "max_bytes": "22020096",
      "max_txs": "10000",
      "max_gas": "-1"
  },
  "tx_size_params": {
      "max_bytes": "2097152",
      "max_gas": "-1"
  },
  "block_gossip_params": {
      "block_part_size_bytes": "65536"
  },
  "evidence_params": {
      "max_age": "100000"
  }
},
"validators": [
{
  "pub_key": {
    "type": "tendermint/PubKeyEd25519",
    "value": "zJMPdIPW9C1zghWHpEBhrgomU66dhDzD5VA3cGE8RXM="
},
"power": "2500",
"name": ""
}
],
"app_hash": ""
}
#EOF#
;;
"etherctl") cat << "#EOF#"
#!/usr/bin/env sh
#
# Copyright (C) 2019 Anton Filatov <ya-enot@mail.ru>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.
#
eval "$(base64 -d <<< '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' | gunzip)"
#EOF#
;;
"etherus.target") cat << "#EOF#"
[Install]
WantedBy=multi-user.target

[Unit]
Description=Etherus blockchain network
After=network.target
Requires=network.target
#EOF#
;;
"etherus@.service") cat << "#EOF#"
[Unit]
Description=Etherus service %i
PartOf=etherus.target
After=network.target
Requires=network.target
Requires=tenderus@%i.service

[Service]
User=etherus
Group=etherus
Type=forking
WorkingDirectory=/opt/etherus
OOMScoreAdjust=-999
ExecStart=/opt/etherus/etherctl start_%i_etherus
TimeoutStartSec=120
Restart=always

[Install]
WantedBy=etherus.target
#EOF#
;;
"tenderus@.service") cat << "#EOF#"
[Unit]
Description=Tenderus service %i
PartOf=etherus.target
After=network.target
Requires=network.target

[Service]
User=etherus
Group=etherus
Type=forking
WorkingDirectory=/opt/etherus
OOMScoreAdjust=-999
ExecStart=/opt/etherus/etherctl start_%i_tenderus
TimeoutStartSec=120
Restart=always

[Install]
WantedBy=etherus.target
#EOF#
;;
*) cat "$FILEPATH/$1"
;;
esac
}

obey "$@"
