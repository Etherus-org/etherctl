#!/usr/bin/env sh
#
# Copyright (C) 2019 Anton Filatov <ya-enot@mail.ru>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.
#

SERVICENAME='etherus'
SERVICEPATH='/opt/etherus'
SERVICECTLS="$SERVICEPATH/etherctl"

###################################################################################################

_cmd_() {
    obey install
}

_cmd_install() {
    obey version && \
    obey synctime || {
        local EXIT=$?
        echo "Failed to synchronise time. Please do it manually then try again."
        return $EXIT
    } && \
    obey init && \
    obey rollout "$@" && \
    echo "Etherus installed successfully" || {
        local EXIT=$?
        echo "Etherus installation failed"
        return $EXIT
    }
    obey firewall || {
        echo "Firewall was not configured"
        echo "Please open ports 6656/tcp, 6657/tcp and 6660/tcp manually..."
    }
    obey install_service || {
        echo "Etherus daemon was not installed"
    }
}

_cmd_version() {
    echo "Etherus install script v0.1.7"
}

_cmd_synctime() {
    _synctime_check_ntpenabled || {
        echo "Precise time is required by Etherus" >&2
        echo "Please check the time synchronization consistency" >&2
        _synctime_check_ntpsynced
    }
}

_synctime_check_ntpenabled() {
    local NTPENABLED;
    NTPENABLED="$( (timedatectl | grep 'NTP enabled:' | sed 's/.*: \(.*\)/\1/') 2>&1 )" && {
        case "$NTPENABLED" in
            [Yy]* ) echo "Time synchronization enabled"
            ;;
            [Nn]* ) echo "Time synchronization disabled" >&2
            return 1
            ;;
            * ) echo "Time synchronization is: $NTPENABLED" >&2
            return 2
        esac
    } || {
        echo "Failed to detect time synchronization: $NTPENABLED" >&2
        return 3
    }
}

_synctime_check_ntpsynced() {
    local NTPSYNCED;
    NTPSYNCED="$( (timedatectl | grep 'NTP synchronized:' | sed 's/.*: \(.*\)/\1/') 2>&1 )" && {
        case "$NTPSYNCED" in
            [Yy]* ) echo "Time synchronized"
            ;;
            [Nn]* ) echo "Time not synchronized" >&2
            return 1
            ;;
            * ) echo "Time synchronization state is: $NTPSYNCED" >&2
            return 2
        esac
    } || {
        echo "Failed to detect time synchronization state: $NTPSYNCED" >&2
        return 3
    }
}

_cmd_init() {
    id -u "$SERVICENAME" &>/dev/null || {
        useradd -d "$SERVICEPATH" -r -s /bin/false "$SERVICENAME" || {
            echo "Failed to create service user: $SERVICENAME" >&2
            return 1
        }
    }

    [ -d "$SERVICEPATH/" ] || {
        mkdir -m 750 -p "$SERVICEPATH/" || {
            echo "Failed to create service directory: $SERVICEPATH" >&2
            return 2
        }
        chown -R "$SERVICENAME:$SERVICENAME" "$SERVICEPATH/" || {
            echo "Failed to change service directory owner: $SERVICEPATH" >&2
            return 3
        }
    }

    [ -d "$SERVICEPATH/bin" ] || {
        mkdir -m 750 -p "$SERVICEPATH/bin" || {
            echo "Failed to create binaries directory: $SERVICEPATH" >&2
            return 4
        }
        chown -R "$SERVICENAME:$SERVICENAME" "$SERVICEPATH/bin" || {
            echo "Failed to change binaries directory owner: $SERVICEPATH" >&2
            return 5
        }
    }

    [ -x "$SERVICECTLS" ] && [ "$(cat "$SERVICECTLS" | md5sum)" = "$(getFile 'etherctl' | md5sum)" ] || {
        touch "$SERVICECTLS" && \
        chmod 755 "$SERVICECTLS" && \
        getFile 'etherctl' > "$SERVICECTLS" || {
            echo "Failed to download service control script" >&2
            return 6
        }
    }
}

_args_rollout() {
    local ARGNAME
    while [ $# -gt 0 ]
    do
        case "$1" in
        -vpk|--validator-private-key)
            ARGNAME="ROLLOUT_VALIDATOR_PRIVATE_KEY"
            ;;
        -vcn|--validator-create-number)
            ARGNAME="ROLLOUT_VALIDATOR_CREATE_NUMBER"
            ;;
        *)
            [ "$ARGNAME" = "" ] && {
                echo "Invalid parameter: $1" >&2
                return 1
            }
            case "$ARGNAME" in
            ROLLOUT_VALIDATOR_PRIVATE_KEY)
                ROLLOUT_VALIDATOR_PRIVATE_KEY+=("$1")
                ;;
            ROLLOUT_VALIDATOR_CREATE_NUMBER)
                ROLLOUT_VALIDATOR_CREATE_NUMBER=$(($1))
                ;;
            *)
                return 2
            esac
        esac
        shift # next parameter
    done
}

_cmd_rollout() {
    [ "$(id -u)" = "$(id -u "$SERVICENAME")" ] || {
        [ -z "$CENTOS7INSTALLSUBSHELL" ] || {
            echo "Failed to run rollout as $SERVICENAME" >&2
            return 1
        }
        export CENTOS7INSTALLSUBSHELL=$$
        su "$SERVICENAME" -s "$(command -v sh || command -v bash)" -c "$0 rollout $(echo "$@")" || {
            echo "Failed to run rollout" >&2
            return 2
        }
        return 0
    }
    _args_rollout "$@" || {
        local EXITCODE=$?
        echo "Failed to parse arguments for rollout: $@" >&2
        return $EXITCODE
    }
    [ -d "$SERVICEPATH/" ] && cd "$SERVICEPATH/" || {
        echo "Unable to access service directory: $SERVICEPATH" >&2
        return 3
    }
    ( PEERS="07e21d35df9ff6ecce28a5f494d95b990da305bc@master.etherus.org:6656" "$SERVICECTLS" "new" ) || {
        echo "Sentry Node creation failed" >&2
        return 10
    }
    getFile "$(pwd)/config" "genesis.json" > "$("$SERVICECTLS" "path")/data/tenderus/config/genesis.json" || {
        echo "Failed to write Etherus genesis to Sentry Node" >&2
        return 11
    }
    local SNID="$("$SERVICECTLS" "getNodeId")" || {
        echo "Failed to get Sentry Node ID" >&2
        return 12
    }
    echo "$SNID" | grep -Eq '^[0-9a-fA-F]{40}$' || {
        echo "Invalid Sentry Node ID: $SNID" >&2
        return 13
    }
    local VALPUBS=()
    createValidator() {
        local NODEPATH="$("$SERVICECTLS" "path_$1")"
        [ -d "$NODEPATH/data/tenderus/config" ] && {
            echo "Validator Node $1 already exists" >&2
            return 20
        }
        mkdir -p "$NODEPATH/data/tenderus/config" || {
            echo "Validator Node $1 preparation failed" >&2
            return 21
        }
        getFile "$(pwd)/config" "genesis.json" > "$NODEPATH/data/tenderus/config/genesis.json" || {
            echo "Failed to write Etherus genesis to Validator Node" >&2
            return 22
        }
        [ $(($1)) -gt 0 ] && [ "${ROLLOUT_VALIDATOR_PRIVATE_KEY[$(($1-1))]}" != "" ] && {
            local PRIVATE_KEY="${ROLLOUT_VALIDATOR_PRIVATE_KEY[$(($1-1))]}"
            PRIVATE_KEY="$(
                case "$PRIVATE_KEY" in
                H4sI*)
                    DECODE() { 
                        base64 -d | gunzip
                    }
                    ;;
                \{*)
                    DECODE() { 
                        cat
                    }
                    ;;
                *)
                    DECODE() { 
                        base64 -d
                    }
                esac
                ( echo "$PRIVATE_KEY" | DECODE ) 2>/dev/null
            )" && [ ! -z "$PRIVATE_KEY" ] && { #"
                echo "Using specified private key $(echo "$PRIVATE_KEY" | md5sum | sed 's/\([0-9a-fA-F]\+\).*/\1/g')"
                echo "$PRIVATE_KEY" > "$NODEPATH/data/tenderus/config/priv_validator.json"
            } || {
                echo "Failed to set private key for Validator Node $1. Using autogenerated..." >&2
            }
        }
        ( PEERS="$SNID@127.0.0.1:6656" "$SERVICECTLS" "new_$1_private" ) || {
            echo "Validator Node $1 creation failed" >&2
            return 23
        }
        local VNID="$("$SERVICECTLS" "getNodeId_$1")" || {
            echo "Failed to get Validator Node $1 ID" >&2
            return 24
        }
        echo "$VNID" | grep -Eq '^[0-9a-fA-F]{40}$' || {
            echo "Invalid Validator Node $1 ID: $VNID" >&2
            return 25
        }
        "$SERVICECTLS" "addPrivatePeer $VNID" || {
            echo "Failed to add Validator Node $1 as peer to Sentry Node" >&2
            return 26
        }
        local VALPUB="$("$SERVICECTLS" "getValidator_$1")" || {
            echo "Failed to get Validator Node $1 Public Key" >&2
            return 27
        }
        echo "$VALPUB" | grep -Eq '^0x[0-9a-fA-F]{64}$' || {
            echo "Invalid Validator Node $1 Public Key: $VALPUB" >&2
            return 28
        }
        VALPUBS+=("$VALPUB")
    }
    local COUNT="${ROLLOUT_VALIDATOR_CREATE_NUMBER:-1}"
    sequence createValidator $(seq $COUNT)
    [ ${#VALPUBS} -gt 0 ] || {
        echo "Invalid Validator Public Key: $VALPUB" >&2
        return 26
    }
    local VALPUBS="$(IFS=$'\n'; echo "${VALPUBS[*]}")"
    echo "$VALPUBS" > 'validator.pub' && {
        echo "Your Validator Public Key is saved to file: $(pwd)/validator.pub"
    } || {
        echo "Failed to write Validator Public Key to file" >&2
    }
    echo "Your validator Public Key:"
    echo "$VALPUBS" | sed 's/^/    /'
}

_cmd_install_service() {
    command -v systemctl &>/dev/null && {
        obey install_service_systemd
        return $?
    }
    echo "Failed to detect system service" >&2
    return 1
}

_cmd_install_service_systemd() {
    [ "$(id -u)" = "0" ] || {
        [ -z "$CENTOS7INSTALLSUBSHELL" ] || {
            echo "Failed to run install_service_systemd as superuser" >&2
            return 1
        }
        export CENTOS7INSTALLSUBSHELL=$$
        su "$SERVICENAME" -s "$0" install_service_systemd "$@" || {
            echo "Failed to run install_service_systemd" >&2
            return 2
        }
        return 0
    }
    [ -f "/etc/systemd/system/etherus.target" ] || getFile "$(pwd)/config/systemd" "etherus.target" > "/etc/systemd/system/etherus.target" || {
        echo "Failed to add etherus target to systemd" >&2
        return 10
    }
    [ -f "/etc/systemd/system/etherus@.service" ] || getFile "$(pwd)/config/systemd" "etherus@.service" > "/etc/systemd/system/etherus@.service" || {
        echo "Failed to add etherus service to systemd" >&2
        return 11
    }
    [ -f "/etc/systemd/system/tenderus@.service" ] || getFile "$(pwd)/config/systemd" "tenderus@.service" > "/etc/systemd/system/tenderus@.service" || {
        echo "Failed to add tenderus service to systemd" >&2
        return 12
    }
    systemctl daemon-reload || {
        echo "Failed to reload systemd daemon" >&2
        return 13
    }
    local WARNINGS=()
    local INSTALLS=0
    addDependency() {
        local OUT;
        OUT+="$(systemctl add-requires "etherus.target" "etherus@$1" 2>&1)" && {
            ((INSTALLS+=1))
        } || {
            OUT+="; $(echo "Requires=etherus@$1.service" >> '/etc/systemd/system/etherus.target')" && {
                ((INSTALLS+=1))
            } || {
                WARNINGS+=("Failed to add etherus $1 service to target: $OUT")
            }
        }
    }
    sequence addDependency $( ETHERCTLRUNPATH="$SERVICEPATH" "$SERVICECTLS" "listall" ) || {
        echo "Failed to add dependencies to target" >&2
        return 14
    }
    [ ${#WARNINGS[@]} -gt 0 ] && {
        echo "Dependencies are not added to etherus:" >&2
        (IFS=$'\n'; echo "${WARNINGS[*]}") >&2
        return 15
    }
    [ ${INSTALLS:-0} -gt 0 ] || {
        echo "No dependencies were added to etherus target" >&2
        return 16
    }
    systemctl daemon-reload || {
        echo "Failed to reload systemd daemon" >&2
        return 13
    }
    systemctl enable etherus.target && {
        echo "Etherus Daemon enabled successfully"
    } || {
        echo "Failed to enable Etherus Daemon" >&2
    }
    systemctl start etherus.target && {
        echo "Etherus Daemon started successfully"
    } || {
        echo "Failed to start Etherus Daemon" >&2
    }
    echo "Use systemctl for administration"
    systemctl list-dependencies etherus.target
}

_cmd_firewall() {
    command -v firewall-cmd &>/dev/null && {
        obey firewall_firewalld
        return $?
    }
    echo "Failed to detect system firewall" >&2
    return 1
}

_cmd_firewall_firewalld() {
    [ "$(id -u)" = "0" ] || {
        [ -z "$CENTOS7INSTALLSUBSHELL" ] || {
            echo "Failed to run firewall_firewalld as superuser" >&2
            return 1
        }
        export CENTOS7INSTALLSUBSHELL=$$
        su "$SERVICENAME" -s "$0" firewall_firewalld "$@" || {
            echo "Failed to run firewall_firewalld" >&2
            return 2
        }
        return 0
    }
    firewall-cmd --permanent --add-port=6656/tcp --add-port=6657/tcp --add-port=6660/tcp >/dev/null || {
        echo "Failed to configure etherus ports" >&2
        return 10
    }
    firewall-cmd --add-port=6656/tcp --add-port=6657/tcp --add-port=6660/tcp >/dev/null || {
        echo "Failed to open etherus ports" >&2
        return 11
    }
    echo "Firewall successfully configured for Etherus"
}

###################################################################################################

obey() {
    [ $# -eq 0 ] || {
        COMMAND="$1"
        shift
    }
    declare -F "_cmd_$COMMAND"&>/dev/null || {
        echo "Unknown command: $COMMAND"
        return -1
    }
    "_cmd_$COMMAND" "$@"
}

sequence() {
    local COMMAND="$1"
    shift
    for i in $@
    do
        $"$COMMAND" $i
    done
}

getFile() {
    [ $# -gt 1 ] && {
        local FILEPATH=$1
        shift
    }
    case "$1" in
        "genesis.json") [ -f "$FILEPATH/$1" ] && cat "$FILEPATH/$1" || cat << "#EOF#"
{
  "genesis_time": "2019-02-25T16:29:48.8917618Z",
  "chain_id": "etherus-main-chain",
  "consensus_params": {
    "block_size_params": {
      "max_bytes": "22020096",
      "max_txs": "10000",
      "max_gas": "-1"
  },
  "tx_size_params": {
      "max_bytes": "2097152",
      "max_gas": "-1"
  },
  "block_gossip_params": {
      "block_part_size_bytes": "65536"
  },
  "evidence_params": {
      "max_age": "100000"
  }
},
"validators": [
{
  "pub_key": {
    "type": "tendermint/PubKeyEd25519",
    "value": "zJMPdIPW9C1zghWHpEBhrgomU66dhDzD5VA3cGE8RXM="
},
"power": "2500",
"name": ""
}
],
"app_hash": ""
}
#EOF#
;;
"etherctl") cat << "#EOF#"
#!/usr/bin/env sh
#
# Copyright (C) 2019 Anton Filatov <ya-enot@mail.ru>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.
#
eval "$(base64 -d <<< 'H4sIAOorAF0CA+w9+VPbSLO/+6+YCG+wSeQLwmZJnMQLJnF9BCgw2U1h1iWsMehhS1pJ5ljw//6659Lo8JGE5KXefqQK7Dl6evruubJSWCHbnn8XOBeXESltl0mjVv+NtNzIc8muM7Ii75q8vrNM6nrRu7HljCrB5E1hBbp1L52Q+IF3EVhjAh+HAaUk9IbRjRXQLXLnTcjAcklAbSeMAud8ElHiRMRy7aoXkLFnO8M7AANFE9emAYkuKYloMA6JN2Rf3u+fkPfUpYE1IoeT85EzIHvOgLohJRaMjCXhJbXJOYLBDruIwbHAgOx6ANeKHM99TqgD9QG5pkEI38m6HELAe068AGCUrAjRDojnY7cy4HpHgARxz0ruzOMJ2sRxGeBLz4fZXAJAmN+NMxqRc0omIR1ORs8BArQlf3S6Hw5OuqS1/5n80To6au13P7+CttGlB7X0mnJIztgfOQAY5hRYbnQHqAOAj+2j7Q/Qo/V7Z6/T/Qz4k91Od799fEx2D45Iixy2jrqd7ZO91hE5PDk6PDhuVwg5pogUhf5zaDtk3AEC2jQCfod8zp+BnSFgNrLJpXVNga0D6lwDXhYZgPws5hnAsEaee8FmCG1jEgJinSEB+XpOQkDw9WUU+eFWtXpzc1O5cCcVL7iojjiQsPoG0Skcnewftrofmkbxvt39ALTo7omiLbNY8m/s8tQoHB0cdDOtRBk2G9jEKJZsJ3CtMYWP97+3jj/0jw9Ojrbbp7WzqVE2yJuqTa+r7gQY2HjztE6ePiUCuoAsAVbPHXeriJ+Mwvbuezmu+AjDqYYDzx06FwDhj4Oj/0goHPmq69k0hJpWp3vY2TlulsqFQmHv4H1/r/2pvdffae+2Tva6zfXCSo3strqtvcJKnbSPjg6OCisNlKL9wso66ezvHhRWNshO+/eT94WVF6R71NpuF0bexQjEalQqk/sCgZ+BFeK86wZK7erqw+mTmvnb2VqZ0MGlR4qZcV+9IqqyVCrWy2UooaE1KExjJJvFkhxIA1EugAadg2CrwUfeAGTk43Fet/v6lrkxLbN2p8SMSI2cMdIHjhsNiWGQhwcBhjcp3itA2JOYIwplanQg/31mNltmYzrlcAegpwAR/7whiuMM/hTmVjglT4iJ0iKZaPB+4yuQHr042xLlYkZrVlUoTHywUrSNBmoSpnlTmjDhNL0yMknNeO1jeBeuldX3FliDpnHjuLZ3A/Iji1+9invsOe7kNtNlhKX5HeKmjOPGNlN+UFM0DHQgTCXgEdEx8cFMguEAXT4cUUQdEHFHngXW2XGt4I4MnRENydhyJ9ZodEciECGdDmBDwaJEHrQE8zPwxj60J4Io4Fq8MbiWSTAAGMAkaSEuwJRMzivQvCqammgsKP8M2vu0oSYR0GgSuKTOCpjQ5pB5nCLz7cvN/uZGhmpF/GNaY3tzI5d2ztuXmzM6rb/cfARyW8Hg0sHSSUB/epI3kiTn09sRyDrgERi+DoyDroeRqVKpcCoNJsGImOYQHBExwz1ixHiEUUVDRoQo1dqLDfqrTW2rfg6f1jfWN843NqzzF+u0Ydde/LZRDawbiW3fnlxRx7TR6Hi+OaxXXlY2k4V9jk5kBZWLf8DskB5DqzQZW+EVqTUaqNhQS0z/+vYfwNT1zBBEyfQhknFCjBlCYm6ntb6cNGCcJLswSXCowKcLGuUR5Wdn9LpuMc1b1CvoDnjZxLwmoidomOllayOKQSCrPkPiJKxiwkgOolHKiXQ/Hu529tqgYqXxFaiHD0CALT1NgkB0VnNmJqWGCsBMOoC1EPKpslXwCUZRjKEDBmJp5dioplVznh5PBkDXEMI+YAyfhE2w3cNDol3Me94I27DqYKwP0ojjEU7l4gox6d/SPyJKr18TY2VlpX2wC78ZPvQWYtAag3YSWhcQmxdrxBC0N8ip/AhW5aJOrIsGAfXDL39qlf19+ALlZ2dniu3w81pUv+m/dt8QYhIS+nQAkT2LBjGcYfIrR4D50Vs6gEhZB5L9ATmWfUAoAwyd0VAweDUI+MEmDq3JKMqHAoEEQwXygwgDU/zOdQRxYTFWXscQ9Djic2Cf5AxyBwkjzxdt4cOcpgArAjVjTS+9G/ldxMsz4RPfseNOECmjGJHOjt6ROEOOKrULSeL1FV8YjGDixpxiREACzyQEIS69YR0HAUVhxK8zMfUtiOexMVqtGy+4Qk5pJidvopZtH1JIq167lh2EiOQTLCM+plmgfS6A8rEBCEyqd0DH3jXN9ObFWQDMvOkgcOjAuYZpCRiOrSPAq7KDi2Hze8rB9c6ZgRNj7yP7uMokB2Z8hYFlr8S4iV6pQbmu4aAZTgFjPlkjB+wKcF5yKi4Redp/6N08qYQ+OHzHVhAYNp2dHKGw6QhiFtZQfESIT548ITtWZIE+gihDPuuCpEBhDgBhBBGA+Ihuy3Opm20sk3pszBIEVeK4Q6+gbGGhMBjbvhWEFNxHSeQWLPtpYkbBDCh3ZJpr2f640ywVS6REOrvHzT40ALdrBhZWvBKp0D18Pn13NiVlML6vOcgyD+fCS2fIjVR7/xMAEk236iK5selghObN3CVGH9Dr8xaYfJKnWu6ZEy2cuFcuxAHSTG4R1bVYYrgK9AxevoaDQkab8tnCY+Pv5Pik+K5QZiQbeZ6vHC7aDmiBCaNRfMeh2Z4CKilMitgIsBaRQfGtaOlS9FvQDAyQAopsuAcC8XnH3OD473vKfXDf4lCbhR8xw4hZV9jtI27F0hByIQArc+wqRB1j69amPhirOqSUdz7EUcTkqT9KZ99YY4EJLxH+JeFxIfoLwUevhtW/eg/FqlG9WIWiW3CUYTlNCC49+wc7LCoRjNg3NBCVtX6vVFnrlYu9h8pasdqrAzyNP4qUMW2AOwhxy6zFPMbcdwXrUQDNiwgmp9Guz/tK5gNTk6LEJPPPTrcpGJSLPh/0GSNSET9PjURjPtQR4wRGNwiQR60CXUFMrds0IQ4i442DwdtbOyH+MvW/pLdKaJjr4esBq7XbVWyD3cwBabzYhHBcxqLxhLUBAJA9GftLDSLbmpSsGrVbA+FX68T4pdaAL0bPNVAMogDz/lWyGsfABYB2AbGHMjecqp0mBL4sdqynxetmQMxR+ZXWeK91DMyR0lwHGU32iFhi5NaFYBlhtdK7B4moT3vTXqX3tlo14qq/amvwvZwBf49/UKr0hZnWn1DR2DLrNfiZpvrsdT5C7TrWpqt4xw3ekVeWSqYpqspyUadYKglA5TKTW1EAbZ7VoegsjqRjGdvzLkIWyUFoN3aiZlGAkCuT51CBYVJ0abmY69C/ISMKVfwHKdKtM56Ah5yMz2nQTA6ZtincpNxcYkdm9vc6++20nrOJdHAKIzYFNkWewdznaFSnWUuUKjrEEJJEyMBJ8S4Jbpr4Nr7mMga/KsWSXDv7pQbiIQaZgiFlNCwb+WgJ9kCGsRxmM+bDwTCW3ufGkJDlmMNFiCoMTAHzGf5FdFLoM1LkI/iFg5kK+7wh5tCed3/2rFwuZBuAxCRqhHtA+QIhfMO4FhtI8MLA8KtUznvY2UHTXN8yi0VhWHmFyIQbvExfJDWKPIl8EnvYtIIVASxPZVlTVRsFlk8MTrger+wBDLT0qs2N5UQCAreBunVFe4hKFE7Ow0hz/DPWduk1zMRgOPUMbi6V5zSqvR763jJggGBZBnQICVIinqjnBhJy02ZRIIEQGrkQkBXcmMyGwRdGGA7Fkpo1dxKrveBtzwU/gb9k9CD2FiQXr6DvE4OhwCfo+cvPj+WJP2J+XAKFK2skXJlQllMpUOlxinXcNsO1TchMMQtILehropR00arFFW6pmZ39rmzWSHpyNY6kCLZiubqPE4LRMgsvLJFP9TD0gI6zJfbvg0s6uMowBkMevkWQQ11ZuRSD6t/IILUXEaOkJTlkI72Jwo2ikWendZuTG7xkHEiG83KNMN8uc37W8rjZyzSO+csaZxvEiUdjho2eam3qMUv54sySyrbf+tj+Bk077ra67YVMFBsUjcS+RK2cUCShRBiQPSPF9WnuBkM92UeqQl7ThtZ0yPQjt9m61gw3NSfhjIYbyaHZujjofP42SCq9hS7IFMgoG7lrzuZ6vLswxWT/y38KBcd12OJG271WfN8/+SgcbE0QVKpRU0srIcU5+ahyo5OP09jywTfG95pY0cbuKDJNzMp4U5A4tP9dsfadI3NidQdBcDEHAeHK2NrZOWoa9cavlRr8q0s1gIH0+hqrlWvJyhUlF4kLbL3HNC+9MW0athVZVbkcb0AxGMTbu77l+00jGvhb1aoadAvCpM3NFy+fldbXYEYsSjLNwB9URpZtB7K9QEK0/jXZ2m/4ydbFe0R9Klpv6q3jtZyZVFIaxiH79LbZM4aQBVAMFzTBqUnqp3deZ1LJNJE0thNwGomp8t98AjE3eKnvBRFazNLLFxsvnpUa2rRvQvYrp99NqHfbTHfzAufCccOmsSYGub70wkh+Z7vsoRPdNY0NUT/wgtD2xpbjxn0s32kaNLp87tLo+Q09X39u0/PJBdZa5wOnn2DIAnZzURlD9Naf1yvFdscf2E5onY+oxlXgCK6d5ivEYznWhEsUpzEyTo85sHb76FgfTS43/BKu4u5VLCi6u3qdha60qcJmhwsxGSeYhC2G5hHjcx4tphIJ7q8svhSeT7HMBOIhmWFjajHNenu257RgDvm5XByIynV4vgwfJsODGclZOiLjK9xbZCEuul/I3e+fEQAwAqGmJaSuLPOXBJK5DHrzNYTi0zxMUWjLSCZkyexNrQqy2GuJIXGQNM1FBvXw1wPzFKvZARO9NDlL0Ac3I34CzTw86nz6DtpZQWeyrIpyHL5cTTMkzJ3R46krn9QindW2r76rwgpsvklrkVYZzUWyLq29nNpvvpp2Qo11oj2eDseDLqPIhTyh4ztvRxMXIpbvoK64GBQME+AUnMSpBy4UNtEa4gpPruhojXAKGJd/twmcZpNjwIsf0jN9vSbXPI28i9ldWG1uNxZdq0M0qWVUUU5UpJnuiVmgE/HlIshf+f5CalwJvaJwyBoJhsUVvYMsMKBVY03bBsxFWAqnQCKFtqzlyPE8YiYIYwH2Sg8S6Ku1DHGg1shbgRZLGKJJ9YK6FFxs5X9CTx7BHPjQxJ/ZZua0pS9KqrYSu/ccCjlnizO88SQAwWb78TMGS8JSKpGEdcHOUkd6Yj2dw6zYZyaIkyehsmnGrukZKdvknW8jsflczyJh8d1AzICnOMZkDKFPrsVcwkbyQbN2MOuzsst8eHp9Lk6ZjaBXqcV9LWucTSCphQvpIyA9AnmSQy4R7mVCvkV0m4drmmyNNNkyUdD8WvSsuUIfBXdHdADeItgF9WrhUVhALXHYAHxHbqvvtFLb7n7o77W67eNuf6fVbeXHcKlGbCUVzyaqI62QlFckC/GoJbMAg0tI3Kuha/nhpReF6ugqXksJo9QabNYkTtyQRumhC/NiODzZw4Erd4S2kB85vqb5u6RpFvElKByrjydXO5/aTaMajX2FvuOGkTUa0aCPwPsCeD9DyRnQ+h93XnwdxMrYfmEUEscWAode45k1MWtGccJXeNhunZrh9snRXp8dl4i3Xfn+MNv3dNmmJyX1GonPSNpJ5eKnUffwpIlR1Gdk4Clh8wuFISt4wreKyxZkHTl1DqnQVX4AH88odQBESrZqADINQr2+LsRaI4UaYu52qJvY8UzS/w6or058q31P1Q6Pr8aIsPKybqP2cqQ14GylYv2aH0fJUCvHYBU02djGDZ5cyYBIJ6IXgRPdqShvmGIoiqhBuCfu/UBB4uM+gjAxTfl3CdTMA/nqxD0Ql4ST8Wx5SoHoMly4XeWRHF4IlEf1EcdEJ3aTIPpnmDEO6gxPr1gtliIfbwiOyuxwD99VZlvKwWqCVbl+XF0TYNuXsSDj2c/UoEn1WNf9OQ9A0jiCxCBxzHMWEWWkMkkbE3KEXhBPRpJWhbzwLU4j5b5rIX90LvUxBubfEwccmTkgSYeZOVWZoc+XkmXjlcQqL3OSobgKLCIQHchoSbpZEugLSWsRIt5GgTWI5jgpJji3/1wP89xKBqf4mgrINQ0eUbooxzRJMnYjZe58NxPzTUvGwZW6C4FmNjE/dQLkO+4ZqGXir17xl2c/kI7P5SnPxDrWty1X5sLP7P+nE3GNHHkJUbxVWyEnIVXnJ3uGS2/Exidhm549g2kOuyyQCkLVyQFVIk8RyNMTOoJa8j+40k8rs81y6PZWOyDLd8ZZTWJ3nO12PzTKM/KtI75bnpcDZs945Z8gG9jpda/7mfdZ7ufedFkqz9Vv/cwDJs97M8EC3sgtULnR0GcS0+TLnzmTnQkLhTSGx1c8GbC+Y0t42GYOzKm6O0dmXb3hwhCL50y5KMwa4IuWlOKOTxNl2mmE1MXM5JUejm6eFMVSaSQPEaXAqyuRU3nM6zsaMXmKbCbKs4gtDWx6n/wxU+gnC1ZJFdicBYhlzFR/aTPFLc1SxipeZ31kW5W0U9kpG4s2GJY0T8usIiWPm/cKC7RX8WwWnQpfoLe5C9nfrrI5BP16jf1+WhErbD7CM+gLeH3lKSh2AUjcnVLz4XjLu7BbpFbZqNT1BRRpLbYgc1UbAQKKUAqZmYtSRJGNxe9G8HG0I1j6bSBt/ee4ffSps80upGBtXdbeZ7SMN8zomeZaHoAveTq3rN949SopgLHcLwd5pmTrgJPCxijGNG0pmglaKFLpxEgTgiQC6PhiVxqh1CyJ7hbye4ljeRJ57SLZI+Ieu80vQV2p7lKYo/X4AlmV8e4XzeSrAuMl45G3Gcs2jzpf4/WWs7Kz8UgQ3Hfs703tJciMIYK6lrAU4RZTbD7MBBH0K5L8xiQXVWU+Hbbira6XqcLE9TUZyCfoNo3vpBrYQ5gsPgreOGGwIH5aigvf7wxQ/uZzIqDJrN/wK+uWi+t8YSSfDShKMZzzKsxUzZQfOkjIEtvoy4kZ04udM/BZjENRLUbG9h7v1v9gFqTcVSxu8cX7Hy4UM6+74EX7RSfohY3AHBVfWfuM97mT5/3Kue26Hw/xxnZcgFdsy+qeMZbvtPfYbeN36WuB8noCb4PW4SKgPjHbf5PVv05r5m+WOWyZu2f3G7Xpu9O/ts6ebWHp2bPianZdnQPruNd4Y5/NGWItCbow9/TUNJ3gqMnst//A18VktZwRm859ggg47Vm7EKf6JJvii1jzTIz1DAwNryznL8ovpD4AiRmgurLrz0kW8euKeqnomj4VoZb18Cp1ERfPXinTnB557SxxeT6zWU2iYEJTyiseufh3aAuTp/na0trZWagt0OZ7aQuC/jJt2T042d9psmOXCxVlGS1hk9O1JDcz18dWUqX/zNsbS+hUkQFJ7NjlKyUi9pMqVkqnMs+w/DzapT/+8s1axk6y/t/6pSWUS5vyf13So2mO3BJ6BO1BMZrlmn5GHfreuvOjvNRX6c5/HdQPdVCPrGbzHBXqlLZCnHy0L+NB2LtsC7UoqwZLynHchZG3pB4aUi989SXNy2mix48SZRyxNBe42SItB0ubUzJo5Bih/4f0SVrYLyeO/mbbz7QIk72zsMz5gYWLLqsS/ip78LB/rV6nW3idQH9Sy4B+E2psGfxpLWOKz2rhsZVzK6SbGzixB/XK0+I3WOM38lBqcpdWZ753O9VZyeXmX8hHdjEe3N1iLi7iRWfnm5jAb0MtyYG8i0HxEa54YREhJBDJuTQge9mUv4XIHiYM8YLs2HLx9ifuVQ8sF19Dwf8jwEVjUtF32PDp/QF738r38BiHw47vjTwwMyjueIeanQR7onf6nQ75G/5iSJ8/HcxPt6WuNsmjp+lppy0jf/zQJ0YLIOP/7xBOAvp2ixjkzk2HSXduZvcbitJbcqef787WSLmQflk1/4ZAvGdTyL42yZdsC/PjkNRG8em+mxl+YSfoIO/+cZpabngDcesdOCX2vKx27lRt4cmn7pgs8ict00+9xy8g6tsWcufVKJPkG8h5r2eo7Yhy6v3keS9tiFno7/bKxzYjMnKu6JYA1pe44DT1osVPrcuZ3zg+1f8TgJL+KB9/2xzhp57liyvYGz1yPyWyAjQM/ztNqEmQ1YH6qSXJ+hANKVBan1wNMQ56xalFZZnJqUTogRVlODQVEeM0PS0MPfkFJTBFcDmkMEvLLEotB5YHusDQRQ82FDldXUSJo6sLab3pgg+aAB2yoV8C2hmHLmyOVdjMACxMmWOo4gDkVAUqAAdB/YqjWkWrKKB7CEioVzUw99uiLZLSxK8ObRINSTXu6U/silCnMzXR5szIX38CPWoWMscJAIQTdh+YaAAA' | gunzip)"
#EOF#
;;
"etherus.target") cat << "#EOF#"
[Install]
WantedBy=multi-user.target

[Unit]
Description=Etherus blockchain network
After=network.target
Requires=network.target
#EOF#
;;
"etherus@.service") cat << "#EOF#"
[Unit]
Description=Etherus service %i
PartOf=etherus.target
After=network.target
Requires=network.target
Requires=tenderus@%i.service

[Service]
User=etherus
Group=etherus
Type=forking
WorkingDirectory=/opt/etherus
OOMScoreAdjust=-999
ExecStart=/opt/etherus/etherctl start_%i_etherus
TimeoutStartSec=120
Restart=always

[Install]
WantedBy=etherus.target
#EOF#
;;
"tenderus@.service") cat << "#EOF#"
[Unit]
Description=Tenderus service %i
PartOf=etherus.target
After=network.target
Requires=network.target

[Service]
User=etherus
Group=etherus
Type=forking
WorkingDirectory=/opt/etherus
OOMScoreAdjust=-999
ExecStart=/opt/etherus/etherctl start_%i_tenderus
TimeoutStartSec=120
Restart=always

[Install]
WantedBy=etherus.target
#EOF#
;;
*) cat "$FILEPATH/$1"
;;
esac
}

obey "$@"
