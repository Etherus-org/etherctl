#!/usr/bin/env sh
#
# Copyright (C) 2019 Anton Filatov <ya-enot@mail.ru>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.
#

SERVICENAME='etherus'
SERVICEPATH='/opt/etherus'
SERVICECTLS="$SERVICEPATH/etherctl"

###################################################################################################

_cmd_() {
    obey install
}

_cmd_install() {
    obey version && \
    obey synctime || {
        local EXIT=$?
        echo "Failed to synchronise time. Please do it manually then try again."
        return $EXIT
    } && \
    obey init && \
    obey rollout "$@" && \
    echo "Etherus installed successfully" || {
        local EXIT=$?
        echo "Etherus installation failed"
        return $EXIT
    }
    obey firewall || {
        echo "Firewall was not configured"
        echo "Please open ports 6656/tcp, 6657/tcp and 6660/tcp manually..."
    }
    obey install_service || {
        echo "Etherus daemon was not installed"
    }
}

_cmd_version() {
    echo "Etherus install script v0.1.7"
}

_cmd_synctime() {
    _synctime_check_ntpenabled || {
        echo "Precise time is required by Etherus" >&2
        echo "Please check the time synchronization consistency" >&2
        _synctime_check_ntpsynced
    }
}

_synctime_check_ntpenabled() {
    local NTPENABLED;
    NTPENABLED="$( (timedatectl | grep 'NTP enabled:' | sed 's/.*: \(.*\)/\1/') 2>&1 )" && {
        case "$NTPENABLED" in
            [Yy]* ) echo "Time synchronization enabled"
            ;;
            [Nn]* ) echo "Time synchronization disabled" >&2
            return 1
            ;;
            * ) echo "Time synchronization is: $NTPENABLED" >&2
            return 2
        esac
    } || {
        echo "Failed to detect time synchronization: $NTPENABLED" >&2
        return 3
    }
}

_synctime_check_ntpsynced() {
    local NTPSYNCED;
    NTPSYNCED="$( (timedatectl | grep 'NTP synchronized:' | sed 's/.*: \(.*\)/\1/') 2>&1 )" && {
        case "$NTPSYNCED" in
            [Yy]* ) echo "Time synchronized"
            ;;
            [Nn]* ) echo "Time not synchronized" >&2
            return 1
            ;;
            * ) echo "Time synchronization state is: $NTPSYNCED" >&2
            return 2
        esac
    } || {
        echo "Failed to detect time synchronization state: $NTPSYNCED" >&2
        return 3
    }
}

_cmd_init() {
    id -u "$SERVICENAME" &>/dev/null || {
        useradd -d "$SERVICEPATH" -r -s /bin/false "$SERVICENAME" || {
            echo "Failed to create service user: $SERVICENAME" >&2
            return 1
        }
    }

    [ -d "$SERVICEPATH/" ] || {
        mkdir -m 750 -p "$SERVICEPATH/" || {
            echo "Failed to create service directory: $SERVICEPATH" >&2
            return 2
        }
        chown -R "$SERVICENAME:$SERVICENAME" "$SERVICEPATH/" || {
            echo "Failed to change service directory owner: $SERVICEPATH" >&2
            return 3
        }
    }

    [ -d "$SERVICEPATH/bin" ] || {
        mkdir -m 750 -p "$SERVICEPATH/bin" || {
            echo "Failed to create binaries directory: $SERVICEPATH" >&2
            return 4
        }
        chown -R "$SERVICENAME:$SERVICENAME" "$SERVICEPATH/bin" || {
            echo "Failed to change binaries directory owner: $SERVICEPATH" >&2
            return 5
        }
    }

    [ -x "$SERVICECTLS" ] && [ "$(cat "$SERVICECTLS" | md5sum)" = "$(getFile 'etherctl' | md5sum)" ] || {
        touch "$SERVICECTLS" && \
        chmod 755 "$SERVICECTLS" && \
        getFile 'etherctl' > "$SERVICECTLS" || {
            echo "Failed to download service control script" >&2
            return 6
        }
    }
}

_args_rollout() {
    local ARGNAME
    while [ $# -gt 0 ]
    do
        case "$1" in
        -vpk|--validator-private-key)
            ARGNAME="ROLLOUT_VALIDATOR_PRIVATE_KEY"
            ;;
        -vcn|--validator-create-number)
            ARGNAME="ROLLOUT_VALIDATOR_CREATE_NUMBER"
            ;;
        *)
            [ "$ARGNAME" = "" ] && {
                echo "Invalid parameter: $1" >&2
                return 1
            }
            case "$ARGNAME" in
            ROLLOUT_VALIDATOR_PRIVATE_KEY)
                ROLLOUT_VALIDATOR_PRIVATE_KEY+=("$1")
                ;;
            ROLLOUT_VALIDATOR_CREATE_NUMBER)
                ROLLOUT_VALIDATOR_CREATE_NUMBER=$(($1))
                ;;
            *)
                return 2
            esac
        esac
        shift # next parameter
    done
}

_cmd_rollout() {
    [ "$(id -u)" = "$(id -u "$SERVICENAME")" ] || {
        [ -z "$CENTOS7INSTALLSUBSHELL" ] || {
            echo "Failed to run rollout as $SERVICENAME" >&2
            return 1
        }
        export CENTOS7INSTALLSUBSHELL=$$
        su "$SERVICENAME" -s "$(command -v sh || command -v bash)" -c "$0 rollout $(echo "$@")" || {
            echo "Failed to run rollout" >&2
            return 2
        }
        return 0
    }
    _args_rollout "$@" || {
        local EXITCODE=$?
        echo "Failed to parse arguments for rollout: $@" >&2
        return $EXITCODE
    }
    [ -d "$SERVICEPATH/" ] && cd "$SERVICEPATH/" || {
        echo "Unable to access service directory: $SERVICEPATH" >&2
        return 3
    }
    env PEERS="07e21d35df9ff6ecce28a5f494d95b990da305bc@master.etherus.org:6656" "$SERVICECTLS" "new" || {
        echo "Sentry Node creation failed" >&2
        return 10
    }
    getFile "$(pwd)/config" "genesis.json" > "$("$SERVICECTLS" "path")/data/tenderus/config/genesis.json" || {
        echo "Failed to write Etherus genesis to Sentry Node" >&2
        return 11
    }
    local SNID="$("$SERVICECTLS" "getNodeId")" || {
        echo "Failed to get Sentry Node ID" >&2
        return 12
    }
    echo "$SNID" | grep -Eq '^[0-9a-fA-F]{40}$' || {
        echo "Invalid Sentry Node ID: $SNID" >&2
        return 13
    }
    local VALPUBS=()
    createValidator() {
        local NODEPATH="$("$SERVICECTLS" "path_$1")"
        [ -d "$NODEPATH/data/tenderus/config" ] && {
            echo "Validator Node $1 already exists" >&2
            return 20
        }
        mkdir -p "$NODEPATH/data/tenderus/config" || {
            echo "Validator Node $1 preparation failed" >&2
            return 21
        }
        getFile "$(pwd)/config" "genesis.json" > "$NODEPATH/data/tenderus/config/genesis.json" || {
            echo "Failed to write Etherus genesis to Validator Node" >&2
            return 22
        }
        [ $(($1)) -gt 0 ] && [ "${ROLLOUT_VALIDATOR_PRIVATE_KEY[$(($1-1))]}" != "" ] && {
            local PRIVATE_KEY="${ROLLOUT_VALIDATOR_PRIVATE_KEY[$(($1-1))]}"
            PRIVATE_KEY="$(
                case "$PRIVATE_KEY" in
                H4sI*)
                    DECODE() { 
                        base64 -d | gunzip
                    }
                    ;;
                \{*)
                    DECODE() { 
                        cat
                    }
                    ;;
                *)
                    DECODE() { 
                        base64 -d
                    }
                esac
                ( echo "$PRIVATE_KEY" | DECODE ) 2>/dev/null
            )" && [ ! -z "$PRIVATE_KEY" ] && { #"
                echo "Using specified private key $(echo "$PRIVATE_KEY" | md5sum | sed 's/\([0-9a-fA-F]\+\).*/\1/g')"
                echo "$PRIVATE_KEY" > "$NODEPATH/data/tenderus/config/priv_validator.json"
            } || {
                echo "Failed to set private key for Validator Node $1. Using autogenerated..." >&2
            }
        }
        env PEERS="$SNID@127.0.0.1:6656" "$SERVICECTLS" "new_$1_private" || {
            echo "Validator Node $1 creation failed" >&2
            return 23
        }
        local VNID="$("$SERVICECTLS" "getNodeId_$1")" || {
            echo "Failed to get Validator Node $1 ID" >&2
            return 24
        }
        echo "$VNID" | grep -Eq '^[0-9a-fA-F]{40}$' || {
            echo "Invalid Validator Node $1 ID: $VNID" >&2
            return 25
        }
        "$SERVICECTLS" "addPrivatePeer $VNID" || {
            echo "Failed to add Validator Node $1 as peer to Sentry Node" >&2
            return 26
        }
        local VALPUB="$("$SERVICECTLS" "getValidator_$1")" || {
            echo "Failed to get Validator Node $1 Public Key" >&2
            return 27
        }
        echo "$VALPUB" | grep -Eq '^0x[0-9a-fA-F]{64}$' || {
            echo "Invalid Validator Node $1 Public Key: $VALPUB" >&2
            return 28
        }
        VALPUBS+=("$VALPUB")
    }
    local COUNT="${ROLLOUT_VALIDATOR_CREATE_NUMBER:-1}"
    sequence createValidator $(seq $COUNT)
    [ ${#VALPUBS} -gt 0 ] || {
        echo "Invalid Validator Public Key: $VALPUB" >&2
        return 26
    }
    local VALPUBS="$(IFS=$'\n'; echo "${VALPUBS[*]}")"
    echo "$VALPUBS" > 'validator.pub' && {
        echo "Your Validator Public Key is saved to file: $(pwd)/validator.pub"
    } || {
        echo "Failed to write Validator Public Key to file" >&2
    }
    echo "Your validator Public Key:"
    echo "$VALPUBS" | sed 's/^/    /'
}

_cmd_install_service() {
    command -v systemctl &>/dev/null && {
        obey install_service_systemd
        return $?
    }
    echo "Failed to detect system service" >&2
    return 1
}

_cmd_install_service_systemd() {
    [ "$(id -u)" = "0" ] || {
        [ -z "$CENTOS7INSTALLSUBSHELL" ] || {
            echo "Failed to run install_service_systemd as superuser" >&2
            return 1
        }
        export CENTOS7INSTALLSUBSHELL=$$
        su "$SERVICENAME" -s "$0" install_service_systemd "$@" || {
            echo "Failed to run install_service_systemd" >&2
            return 2
        }
        return 0
    }
    [ -f "/etc/systemd/system/etherus.target" ] || getFile "$(pwd)/config/systemd" "etherus.target" > "/etc/systemd/system/etherus.target" || {
        echo "Failed to add etherus target to systemd" >&2
        return 10
    }
    [ -f "/etc/systemd/system/etherus@.service" ] || getFile "$(pwd)/config/systemd" "etherus@.service" > "/etc/systemd/system/etherus@.service" || {
        echo "Failed to add etherus service to systemd" >&2
        return 11
    }
    [ -f "/etc/systemd/system/tenderus@.service" ] || getFile "$(pwd)/config/systemd" "tenderus@.service" > "/etc/systemd/system/tenderus@.service" || {
        echo "Failed to add tenderus service to systemd" >&2
        return 12
    }
    systemctl daemon-reload || {
        echo "Failed to reload systemd daemon" >&2
        return 13
    }
    local WARNINGS=()
    local INSTALLS=0
    addDependency() {
        local OUT;
        OUT+="$(systemctl add-requires "etherus.target" "etherus@$1" 2>&1)" && {
            ((INSTALLS+=1))
        } || {
            OUT+="; $(echo "Requires=etherus@$1.service" >> '/etc/systemd/system/etherus.target')" && {
                ((INSTALLS+=1))
            } || {
                WARNINGS+=("Failed to add etherus $1 service to target: $OUT")
            }
        }
    }
    sequence addDependency $(env ETHERCTLRUNPATH="$SERVICEPATH" "$SERVICECTLS" "listall") || {
        echo "Failed to add dependencies to target" >&2
        return 14
    }
    [ ${#WARNINGS[@]} -gt 0 ] && {
        echo "Dependencies are not added to etherus:" >&2
        (IFS=$'\n'; echo "${WARNINGS[*]}") >&2
        return 15
    }
    [ ${INSTALLS:-0} -gt 0 ] || {
        echo "No dependencies were added to etherus target" >&2
        return 16
    }
    systemctl daemon-reload || {
        echo "Failed to reload systemd daemon" >&2
        return 13
    }
    systemctl enable etherus.target && {
        echo "Etherus Daemon enabled successfully"
    } || {
        echo "Failed to enable Etherus Daemon" >&2
    }
    systemctl start etherus.target && {
        echo "Etherus Daemon started successfully"
    } || {
        echo "Failed to start Etherus Daemon" >&2
    }
    echo "Use systemctl for administration"
    systemctl list-dependencies etherus.target
}

_cmd_firewall() {
    command -v firewall-cmd &>/dev/null && {
        obey firewall_firewalld
        return $?
    }
    echo "Failed to detect system firewall" >&2
    return 1
}

_cmd_firewall_firewalld() {
    [ "$(id -u)" = "0" ] || {
        [ -z "$CENTOS7INSTALLSUBSHELL" ] || {
            echo "Failed to run firewall_firewalld as superuser" >&2
            return 1
        }
        export CENTOS7INSTALLSUBSHELL=$$
        su "$SERVICENAME" -s "$0" firewall_firewalld "$@" || {
            echo "Failed to run firewall_firewalld" >&2
            return 2
        }
        return 0
    }
    firewall-cmd --permanent --add-port=6656/tcp --add-port=6657/tcp --add-port=6660/tcp >/dev/null || {
        echo "Failed to configure etherus ports" >&2
        return 10
    }
    firewall-cmd --add-port=6656/tcp --add-port=6657/tcp --add-port=6660/tcp >/dev/null || {
        echo "Failed to open etherus ports" >&2
        return 11
    }
    echo "Firewall successfully configured for Etherus"
}

###################################################################################################

obey() {
    [ $# -eq 0 ] || {
        COMMAND="$1"
        shift
    }
    declare -F "_cmd_$COMMAND"&>/dev/null || {
        echo "Unknown command: $COMMAND"
        return -1
    }
    "_cmd_$COMMAND" "$@"
}

sequence() {
    local COMMAND="$1"
    shift
    for i in $@
    do
        $"$COMMAND" $i
    done
}

getFile() {
    [ $# -gt 1 ] && {
        local FILEPATH=$1
        shift
    }
    case "$1" in
        "genesis.json") [ -f "$FILEPATH/$1" ] && cat "$FILEPATH/$1" || cat << "#EOF#"
{
  "genesis_time": "2019-02-25T16:29:48.8917618Z",
  "chain_id": "etherus-main-chain",
  "consensus_params": {
    "block_size_params": {
      "max_bytes": "22020096",
      "max_txs": "10000",
      "max_gas": "-1"
  },
  "tx_size_params": {
      "max_bytes": "2097152",
      "max_gas": "-1"
  },
  "block_gossip_params": {
      "block_part_size_bytes": "65536"
  },
  "evidence_params": {
      "max_age": "100000"
  }
},
"validators": [
{
  "pub_key": {
    "type": "tendermint/PubKeyEd25519",
    "value": "zJMPdIPW9C1zghWHpEBhrgomU66dhDzD5VA3cGE8RXM="
},
"power": "2500",
"name": ""
}
],
"app_hash": ""
}
#EOF#
;;
"etherctl") cat << "#EOF#"
#!/usr/bin/env sh
#
# Copyright (C) 2019 Anton Filatov <ya-enot@mail.ru>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.
#
eval "$(base64 -d <<< 'H4sIAM8CAF0CA+w8aVPbyLbf/Ss6wjfYJPIGYTIkTuIBk7guWxmTmRRmXMJqGz1sSSPJGAb83985vUitxQsJzEu9e6EK7F5Onz776W0tt0Z2HffOs4ZXASnsFkmtUv2VNOzAscm+NTIC54a8vzN0ajvBp7FhjUre5ENuDbp1riyfuJ4z9IwxgY8Dj1LiO4Nganh0h9w5E9I3bOJR0/IDz7qcBJRYATFss+x4ZOyY1uAOwEDRxDapR4IrSgLqjX3iDNiXz0dn5DO1qWeMyMnkcmT1yYHVp7ZPiQEjY4l/RU1yiWCwwz5icCowIPsOwDUCy7FfE2pBvUduqOfDd7IphxDwXhPHAxgFI0C0PeK42K0IuN4RIEHUs5Q582iCJrFsBvjKcWE2VwAQ5je1RiNyScnEp4PJ6DVAgLbk91bny/FZhzSOvpHfG+1246jz7R20Da4cqKU3lEOyxu7IAsAwJ8+wgztAHQAcNtu7X6BH47fWQavzDfAn+63OUfP0lOwft0mDnDTandbu2UGjTU7O2ifHp80SIacUkaLQfwFtB4w7QECTBsBvn8/5G7DTB8xGJrkybiiwtU+tG8DLIH2Qn+U8AxjGyLGHbIbQNiIhINYaEJCv18QHBN9fBYHr75TL0+m0NLQnJccblkcciF/+gOjk2mdHJ43Ol7qWv292vgAtOgeiaEfPF9ypWZxpufbxcSfVSpRhs75JtHzBtDzbGFP4eP9b4/RL7/T4rL3bPK9czLSiRj6UTXpTtifAwNqHl1Xy8iUR0AVkCbB8adk7efyk5Xb3P8txxUcYLmzYd+yBNQQIvx+3/y2hcOTLtmNSH2oarc5Ja++0XijmcrmD48+9g+bX5kFvr7nfODvo1Gu5tQrZb3QaB7m1Kmm228ft3FoNpegot7ZJWkf7x7m1LbLX/O3sc27tDem0G7vN3MgZjkCsRoUiuc8R+OkbPs67qqHUrq8/nL+o6L9ebBQJ7V85JJ8a9907ElYWCvlqsQgl1Df6uVmEZD1fkAMpIIo50KBLEOxw8JHTBxk5PM3qdl/d0bdmRdbunOgBqZALRnrPsoMB0TTy8CDA8Cb5+xAQ9iT6iEJZODqQ/z41mx29NptxuH3QU4CI/z6QkOMM/gzmljsnL4iO0iKZqPF+42uQHrU43RLlYk5rVpXLTVywUrSJBmriJ3lTmDDh1J0iMimc8cahf+dvFMPvDbAGdW1q2aYzBfmRxe/eRT0OLHtym+oywtLsDlFTxnFtlyk/qCkaBtoXphLwCOiYuGAmwXCALp+MKKIOiNgjxwDrbNmGd0cG1oj6ZGzYE2M0uiMBiJBKB7ChYFECB1qC+ek7YxfaE0EUcC3OGFzLxOsDDGCStBBDMCWTyxI0L4umOhoLyj+D9r6shZPwaDDxbFJlBUxoM8g8TpD59u12b3srRbU8/tONsbm9lUk76+Pb7TmdNt9uPwG5Da9/ZWHpxKM/PclrcZLz6e0JZC3wCAxfC8ZB18PIVCqVOJX6E29EdH0Ajojo/gHRIjz8oKQgI0KUcuXNFv3FpKZRvYRPm1ubW5dbW8blm01aMytvft0qe8ZUYtszJ9fU0k00Oo6rD6qlt6XteGGPoxMYXmn4N5gd0mVoFSZjw78mlVoNFRtqie7e3P4NmNqO7oMo6S5EMpaPMYNP9N2k1hfjBoyTZB8mCQ4V+DSkQRZRfnZGb6oWU79FvYLugJdJ9BsieoKG6U66NqAYBLLqCyROzCrGjGQ/GCWcSOfwZL910AQVK4yvQT1cAAJs6SoSBKKznjEzKTVUAGbSAayFkC8sWwefoOXFGCpgIJZSjo0qSjXn6emkD3T1IewDxvBJmATbPTzE2kW8542wDav2xuogtSge4VTOrxGd/iX9I6L0/j3R1tbWmsf78JfhQ28hBq0waGe+MYTYPF8hmqC9Rs7lR7AqwyoxhjUC6odf/lAqe0fwBcovLi5CtsPPe1H9offe/kCITojv0j5E9iwaxHCGya8cAeZHb2kfImUVSPoH5Fj2AaH0MHRGQ8HgVSDgB5s4MCajIBsKBBIMFcgPAgxM8TvXEcSFxVhZHX3Q44DPgX2SM8gcxA8cV7SFDwuaAqwA1Iw1vXKm8ruIl+fCJ65lRp0gUkYxIq09tSOxBhxVaubixOuFfGEwvIkdcYoRAQk8lxCE2HTKOvY9isKIX+di6hoQz2NjtFpTx7tGTikmJ2uihmmeUEir3tuG6fmI5AssIy6mWaB9NoBysQEITKK3R8fODU315sVpAMy8qSBwaM+6gWkJGJapIsCr0oOLYbN7ysHVzqmBY2MfIfu4ysQHZnyFgWWv2LixXolBua7hoClOAWO+GiML7ApwXnIqKhF52r/p3SKphD44fMsMITBsWnsZQmHSEcQsrKH4iBBfvHhB9ozAAH0EUYZ81gZJgcIMAMIIIgDxEd2WY1M73Vgm9diYJQhhiWUPnFxoC3O5/th0Dc+n4D4KIrdg2U8dMwpmQLkjU1zL7uFevZAvkAJp7Z/We9AA3K7uGVjxTqRC9/D5/NPFjBTB+L7nIIs8nPOvrAE3Us2jrwBINN2piuTGpP0Rmjd9n2g9QK/HW2DySV4quWdGtHBmX9sQB0gzuUPCrvkCw1Wgp/HyDRwUMtqEzxYeG//Gxyf5T7kiI9nIcdzQ4aLtgBaYMGr5Txya6YRAJYVJHhsB1iIyyH8ULW2KfguagQEKgSIb7oFAfN4RNzj+R07oPrhvsajJwo+IYUSvhtgdIW75wgByIQArc+wyRB1j49akLhirKqSUdy7EUUTnqT9KZ0/bYIEJLxH+JeZxIfrzwUev++U/uw/5slYerkPRLThKv5gkBJeeo+M9FpUIRhxpCojSRq9bKG10i/nuQ2kjX+5WAZ7Cn5CUEW2AOwhxR69EPMbcdw3rUQD1YQCTU2jX430l84GpcVFikvlHq1MXDMpEnw/6ihEpj59nWqwxH6rNOIHRDQLkUatAVxBT6TaLiYPIeKNg8PbWjIm/TP2v6G0oNMz18PWA9crtOrbBbnqf1N5sQzguY9FowsoAAMicjN2VBpFtdUrWtcqthvDLVaL9q1KDL1rX1lAMAg/z/nWyHsXAOYA2hNgjNDecqq06BL4sdqwmxWvaJ/qo+E5pfNA4BeZIaa6CjMZ7BCwxsqtCsDS/XOreg0RUZ91Zt9T9WC5rUdWflQ34XkyBv8d/KFXqwkzjD6io7ejVCvzMEn0OWodQu4m1ySrecYt35JWFgq6LqqJc1MkXCgJQscjkVhRAm1dVKLqIIulIxg6coc8iOQjtxlZQzwsQcmXyEiowTAquDBtzHfoXZER+GP9BinRrjSfgISfjS+rV40MmbQo3KdMr7MjM/kHrqJnUczaRFk5hxKbApsgzmPsMjWrVK7HSkA4RhDgRUnASvIuDm8W+jW+4jMGfUr4g187+VQHxEIPMwJAyGha1bLQEeyDDWA2zOfPhYBhL7zNjSMhy9MEyREMMdAHzFf5HdBLoM1JkI/jIwfQQ+6whFtCed3/1qljMpRuAxMRqhHtA+QIh/MC4FhlI8MLA8OtEznvS2kPTXN3R83lhWHmFyIRrvExdJNXyPIl8EXnYpILlASxPZVnTsDbwDJdonHBdXtkFGGjpwzZTwwoEBG4DVeuK9hCVyJ9c+oHi+Oes7dIbmInGcOpq3FyGnlMrd7voe4uAAYJlGdAJJEixeKKaGUjITZtlgQRCqGVCQFZwYzIfBl8YYTjkC+GsuZNY73ofuzb4CfwjowextyC5eA19X2gMBT5Bx119fixP/CfmxyVQuLJazJUJZTmXApUcJ1/FbTNc24TMFLOAxIK+IkpxFx22uMYtNb111JHNanFPHo4jKYKtWK7u4oRgtNTCC0vkEz00NaDjbIn8e/+K9q9TjMGQh28RZFBXVq7EoOoPMijci4hQUpIcspXcROFGUcuy06rNyQxeUg4kxXm5Rphtlzk/K1nc7KYaR/xljdMNosSjNsdGz5Q21YilfHFmRWU7ahw2f0DTTjuNTnMpE8UGRS22L1EpxhRJKBEGZK9IfnOWucFQjfeRqpDVtKY0HTD9yGy2qTTDTc2JP6fhVnxoti4OOp+9DZJIb6ELMgUyylrmmrO+Ge0uzDDZf/xPLmfZFlvcaNo3Id+Pzg6Fg60Igko1qitpJaQ4Z4dhbnR2OIssH3xjfK+IFW3sjiJTx6yMNwWJQ/vfEWvfGTInVncQBBdzEBCujI29vXZdq9Z+KVXgtyrVAAZS6yusVq4lh64ovkicY+s9un7ljGldM43AKMvleA2KwSDe3vUM161rQd/dKZfDQXcgTNrefvP2VWFzA2bEoiRd99x+aWSYpifbCyRE61/ird2aG2+dv0fUZ6L1tto6WsuZS6VQwzhkl97Wu9oAsgCK4YIiOBVJ/eTO61wq6TqSxrQ8TiMxVf6XTyDiBi91HS9Ai1l4+2brzatCTZn21Gd/MvpNfbXbdrKb41lDy/br2oYY5ObK8QP5ne2y+1ZwV9e2RH3f8XzTGRuWHfUxXKuu0eDqtU2D11N6ufnapJeTIdYal32rF2PIEnZzURlD9NZb1CvBdsvtm5ZvXI6owlXgCK6dZivEUznWmEsUpzFSTo85sGazfaqOJpcb/uWv4+5VJCiqu3qfhh5qU4nNDhdiUk4wDlsMzSPG1zxaTCQS3F8ZfCk8m2KpCURDMsPG1GKW9vZsz2nJHLJzuSgQlevwfBnej4cHc5KzZETGV7h3yFJcVL+Qud8/JwBgBEJNi0ldUeYvMSQzGfThewjFp3mSoNCOFk/I4tlbuCrIYq8VhsRBkjQXGdTDnw/MU6ynB4z1UuQsRh/cjPgJNPOk3fr6DNpZQmeyqopyHB6vpikSZs7o6dSVT2qZzirbV8+qsAKbH9JapFVKc5GsK2svp/aH76adUGOVaE+nw9GgqyhyLkvo+M5be2JDxPIM6oqLQd4gBi6EEzv1wIXCJEpDXOHJFB2lEU4B4/Jnm8B5OjkGvPghPd1VazLN08gZzu/CajO7seg6PESTWEYV5SSMNJM9MQu0Ar5cBPkr319IjCuhl0Ic0kaCYXFN7yAL9GhZ21C2ATMRlsIpkEigLWs5cjyPmAtCW4J9qAcx9MO1DHGgVstagRZLGKJJeUhtCi629D++I49g9l1o4s5tM3fa0hfFVTsUu88cCrlkizO88cQDwWb78XMGi8MKVSIOa8jOUgdqYj1bwKzIZ8aIkyWhsmnKrqkZKdvkXWwjsflCzyJh8d1AzIBnOMZkDKFPpsVcwUbyQdN2MO2z0st8eHp9IU6pjaB3icV9JWucTyCphUvpIyA9AXniQ64Q7qVCvmV0W4Rrkmy1JNlSUdDiWvSsmUIfeHdt2gdv4e2DejXwKCygFjtsAL4js9UzrdQ2O196B41O87TT22t0GtkxXKIRW0nFs4nhkVZIykuShXjUklmA/hUk7mXfNlz/ygn88OgqXkvxg8QabNokTmyfBsmhc4tiODzZw4GH7ghtIT9yfEOzd0mTLOJLUDhWD0+utr4261o5GLsh+pbtB8ZoRL0eAu8J4L0UJXOxAwaeRW/wdJnAj9GG8LUYtq8W4rJ71j7osYMN0QYp38llO5Q2256kpFoh0WlGM64G/NzoAZ4J0fLqTDQ8z6s/km1pEQESXkKOcp0dWUcTSJzMkCIXNgBhA2nb3BTypsw8HGLhPqUd24qMk/sOiB0exQ43JMN2eK40QoSVF1XjcZAhRh7nIhULy/ycSIo4cyyJOBmP+y6ZYgABSECHnhXccZTZwezg70GKg+GRiG6+nC8ELl64GhXZWQm+Scd26DzcoRP3VsTGRUpd2CZQNC6eoEuMFZ/LZmwuOsRJXS/C4Ph6ftQovXpoowIgHgTHJNksPuBWnHjN28Az+sECLWJEu/37ZpAl9ymcohPvzhRClSekLOWYxsnJDrcvnO+blQgszgDE5hduJj/j8mO44vTdi4dyGxnp+FoeGIulxD+28pEJP7WVmIzpFXJkxVbRrk+JnPk0PIrV1Ww6FXsohO2fdDWmVezcccKfhZuQYYnckJQbsSqCSh7Rv1YPPrJ9N+j2UTlrxzfZWE1so41tnD3UinNCtzbfeMsKJ9PHRbIPo/TNZAp9P/do/P3CQ/MrhczqBYJFwOTRUSZYwBu5myLXLHtMYup8JSVjsnNhoZBG8PjiCQPWs0wJD9ssgDkLr+GQeaf4uTBE4jlXLnLzBnhUdhp1fBkrUzY2E3e84rcDOLpZUhRJpRY/j5AAH96umskTI89oxOSBlLkozyO2NLDJLbenjMZfLFlwCcFm5DKrmKneymaKW5qVjFW0ZPPEtipup9JT1patVa5onlZJSOMnV7u5Jdob8mwenXKP0NvMNbEfV9kMgn6/xj6fVkQKm43wHPoCXt95oILdJRDXMML5cLzltbodUiltlapqhietxQ7kaOGaooAilELmEqIUUWRj8WPWfBzlNId6sUBJTE+b7a+tXXa2HWursvY+pWW8YUrPFNfyAHzJ0rlV/ca7d3EBjOR+NchzJVsFHBc2RjGmaSvRTNAiJJVKjCQhSCyAju6IJBFKzJKobiG7lzjhI5FX7qQ8Ie6R23wM6qHqroQ5Wo9HyKqMdx81k+8KjFeMRz6mLNsi6nyP11vNys7HI0Zw1zKfm9orkBlDhPCE80qEW06xxTBjRFBvW/HLV1xUQ/NpseW48KZKWBi7CSMD+RjdZtH1Ng17CJPFR8HD6wwWxE8rceH5jhNk72PFAprU2g6//WrYuNTlB/IGcl6K4YIHJmbhTPn+ZUyW2J5BRsyYXO+bg89yHPLhelxk7/Ga7j/MgoS7isQtusP7jwvF3JPzeGd32WFcYSMwR8UHm77h1dD40aFiZrvO4Qle/owK8LZeMbyyiOV7zQN2cfFT8oaRPOnM26B1GHrUJXrzL7L+53lF/9XQBw19/+J+qzL7dP7nzsWrHSy9eJVfTy8tc2At+wYv/7I5Q6wlQecWHsSYJROccDJHzd/xoSJZLWfEpnMfIwJOe956+7k6ybr4ItY8Y2O9AkPDK4vZ69JLqQ9AIgaEXdlNyjiL+M0ntVR0TW6whst6eCszj4tn70LTnBx54yJ2Dze170UCb0ITyivuy/9naAuTp8Xa0tjbW6ot0Oa5tAVBP05b9o/Pjvbq7ATXUkVZRUvY5FQtyczM1bFDqVJ/Fm0PxXQqz4DENq2ylRIR+0kVK6FTqRcdfh7tUt+R+GEtY4fi/m/90grKpUz5vy7pyTRHbgk9gfagGM1zTT+jDj237vxTXuq7dOe/DuofdVBPrGaLHBXqlLJCHH//K+VB2BNPS7UorQYrynHUhZG3EL5ZEj4W1JM0LyaJHr1vknLE0lzgZou0HCxtTsiglmGE/h/SJ25hH08c9fmnn2kRJn38eZXzA0sXXdYl/HX2dlrvJnzoaunJZPV1Hg36Tai2o/FXerQZvtCDx1YuDZ9ub+HEHsIHY5Y/5xg9t4VSk7m0OvfpzJnKSi43/4F8ZHdswd0t5+IyXrT2fogJ/GLFihzIumMQHeGKFhYRQgyRjPPHspdJ+bNq7I0zH+/ajQ0bL5LhXnXfsPFhBXxu3EZjUlJ32PAV7z57Ksd18BiHxR4MHTlgZlDc8TomOwn2Qu30Gx3w58DFkC5/hZSffEvckpCHLJPTTlpG/o6aS7QGQMan4v2JRz/uEI3c2ckw6c5O7X5DUXJL7vzb3cUGKeaSjzRmHzaO9mxy6Yfr+JJtbnEcktgoPj+yU8Mv7QQd5DUiTlPD9qcQt96BU2IvVSpHL8MtPPlqFpNF/jpe8tXo6DE1ddtC7rxqRRJ/TjXrIn64HVFMPMW66NK+mIX6BKh8ty8gI+ua7ghgPYkLTlMtWv5qs5z51HKp+p54QX3fiz+TjPATL3xFFey5D7mfEhgeGoaigMRPB5Zp0C/zDqb4X/7eDt1PJZ96N1afrtBHmrI5nbxVUCttpPo4biAbhXUKzQaWR6dgD3SgbpJssTpdjyyOrvPoTWd31vG+fjnASzbJ4l8yi7crrPjHkHkSBFSpQgP4E/jXOW414SjEuedH+NVC+upe4pBUcXG7xCaa0vp/h3v6E7si1OlMTbQ5M/LXn0BPrYTMcQIAnmzmseNkAAA=' | gunzip)"
#EOF#
;;
"etherus.target") cat << "#EOF#"
[Install]
WantedBy=multi-user.target

[Unit]
Description=Etherus blockchain network
After=network.target
Requires=network.target
#EOF#
;;
"etherus@.service") cat << "#EOF#"
[Unit]
Description=Etherus service %i
PartOf=etherus.target
After=network.target
Requires=network.target
Requires=tenderus@%i.service

[Service]
User=etherus
Group=etherus
Type=forking
WorkingDirectory=/opt/etherus
OOMScoreAdjust=-999
ExecStart=/opt/etherus/etherctl start_%i_etherus
TimeoutStartSec=120
Restart=always

[Install]
WantedBy=etherus.target
#EOF#
;;
"tenderus@.service") cat << "#EOF#"
[Unit]
Description=Tenderus service %i
PartOf=etherus.target
After=network.target
Requires=network.target

[Service]
User=etherus
Group=etherus
Type=forking
WorkingDirectory=/opt/etherus
OOMScoreAdjust=-999
ExecStart=/opt/etherus/etherctl start_%i_tenderus
TimeoutStartSec=120
Restart=always

[Install]
WantedBy=etherus.target
#EOF#
;;
*) cat "$FILEPATH/$1"
;;
esac
}

obey "$@"
