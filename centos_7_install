#!/usr/bin/env sh
#
# Copyright (C) 2019 Anton Filatov <ya-enot@mail.ru>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.
#

SERVICENAME='etherus'
SERVICEPATH='/opt/etherus'
SERVICECTLS="$SERVICEPATH/etherctl"

###################################################################################################

_cmd_() {
    obey install
}

_cmd_install() {
    obey version && \
    obey synctime || {
        local EXIT=$?
        echo "Failed to synchronise time. Please do it manually then try again."
        return $EXIT
    } && \
    obey init && \
    obey rollout "$@" && \
    echo "Etherus installed successfully" || {
        local EXIT=$?
        echo "Etherus installation failed"
        return $EXIT
    }
    obey firewall || {
        echo "Firewall was not configured"
        echo "Please open ports 6656/tcp, 6657/tcp and 6660/tcp manually..."
    }
    obey install_service || {
        echo "Etherus daemon was not installed"
    }
}

_cmd_version() {
    echo "Etherus install script v0.1.7"
}

_cmd_synctime() {
    _synctime_check_ntpenabled || {
        echo "Precise time is required by Etherus" >&2
        echo "Please check the time synchronization consistency" >&2
        _synctime_check_ntpsynced
    }
}

_synctime_check_ntpenabled() {
    local NTPENABLED;
    NTPENABLED="$( (timedatectl | grep 'NTP enabled:' | sed 's/.*: \(.*\)/\1/') 2>&1 )" && {
        case "$NTPENABLED" in
            [Yy]* ) echo "Time synchronization enabled"
            ;;
            [Nn]* ) echo "Time synchronization disabled" >&2
            return 1
            ;;
            * ) echo "Time synchronization is: $NTPENABLED" >&2
            return 2
        esac
    } || {
        echo "Failed to detect time synchronization: $NTPENABLED" >&2
        return 3
    }
}

_synctime_check_ntpsynced() {
    local NTPSYNCED;
    NTPSYNCED="$( (timedatectl | grep 'NTP synchronized:' | sed 's/.*: \(.*\)/\1/') 2>&1 )" && {
        case "$NTPSYNCED" in
            [Yy]* ) echo "Time synchronized"
            ;;
            [Nn]* ) echo "Time not synchronized" >&2
            return 1
            ;;
            * ) echo "Time synchronization state is: $NTPSYNCED" >&2
            return 2
        esac
    } || {
        echo "Failed to detect time synchronization state: $NTPSYNCED" >&2
        return 3
    }
}

_cmd_init() {
    id -u "$SERVICENAME" &>/dev/null || {
        useradd -d "$SERVICEPATH" -r -s /bin/false "$SERVICENAME" || {
            echo "Failed to create service user: $SERVICENAME" >&2
            return 1
        }
    }

    [ -d "$SERVICEPATH/" ] || {
        mkdir -m 750 -p "$SERVICEPATH/" || {
            echo "Failed to create service directory: $SERVICEPATH" >&2
            return 2
        }
        chown -R "$SERVICENAME:$SERVICENAME" "$SERVICEPATH/" || {
            echo "Failed to change service directory owner: $SERVICEPATH" >&2
            return 3
        }
    }

    [ -d "$SERVICEPATH/bin" ] || {
        mkdir -m 750 -p "$SERVICEPATH/bin" || {
            echo "Failed to create binaries directory: $SERVICEPATH" >&2
            return 4
        }
        chown -R "$SERVICENAME:$SERVICENAME" "$SERVICEPATH/bin" || {
            echo "Failed to change binaries directory owner: $SERVICEPATH" >&2
            return 5
        }
    }

    [ -x "$SERVICECTLS" ] && [ "$(cat "$SERVICECTLS" | md5sum)" = "$(getFile 'etherctl' | md5sum)" ] || {
        touch "$SERVICECTLS" && \
        chmod 755 "$SERVICECTLS" && \
        getFile 'etherctl' > "$SERVICECTLS" || {
            echo "Failed to download service control script" >&2
            return 6
        }
    }
}

_args_rollout() {
    local ARGNAME
    while [ $# -gt 0 ]
    do
        case "$1" in
        -vpk|--validator-private-key)
            ARGNAME="ROLLOUT_VALIDATOR_PRIVATE_KEY"
            ;;
        -vcn|--validator-create-number)
            ARGNAME="ROLLOUT_VALIDATOR_CREATE_NUMBER"
            ;;
        *)
            [ "$ARGNAME" = "" ] && {
                echo "Invalid parameter: $1" >&2
                return 1
            }
            case "$ARGNAME" in
            ROLLOUT_VALIDATOR_PRIVATE_KEY)
                ROLLOUT_VALIDATOR_PRIVATE_KEY+=("$1")
                ;;
            ROLLOUT_VALIDATOR_CREATE_NUMBER)
                ROLLOUT_VALIDATOR_CREATE_NUMBER=$(($1))
                ;;
            *)
                return 2
            esac
        esac
        shift # next parameter
    done
}

_cmd_rollout() {
    [ "$(id -u)" = "$(id -u "$SERVICENAME")" ] || {
        [ -z "$CENTOS7INSTALLSUBSHELL" ] || {
            echo "Failed to run rollout as $SERVICENAME" >&2
            return 1
        }
        export CENTOS7INSTALLSUBSHELL=$$
        su "$SERVICENAME" -s "$(command -v sh || command -v bash)" -c "$0 rollout $(echo "$@")" || {
            echo "Failed to run rollout" >&2
            return 2
        }
        return 0
    }
    _args_rollout "$@" || {
        local EXITCODE=$?
        echo "Failed to parse arguments for rollout: $@" >&2
        return $EXITCODE
    }
    [ -d "$SERVICEPATH/" ] && cd "$SERVICEPATH/" || {
        echo "Unable to access service directory: $SERVICEPATH" >&2
        return 3
    }
    ( PEERS="07e21d35df9ff6ecce28a5f494d95b990da305bc@master.etherus.org:6656" "$SERVICECTLS" "new" ) || {
        echo "Sentry Node creation failed" >&2
        return 10
    }
    getFile "$(pwd)/config" "genesis.json" > "$("$SERVICECTLS" "path")/data/tenderus/config/genesis.json" || {
        echo "Failed to write Etherus genesis to Sentry Node" >&2
        return 11
    }
    local SNID="$("$SERVICECTLS" "getNodeId")" || {
        echo "Failed to get Sentry Node ID" >&2
        return 12
    }
    echo "$SNID" | grep -Eq '^[0-9a-fA-F]{40}$' || {
        echo "Invalid Sentry Node ID: $SNID" >&2
        return 13
    }
    local VALPUBS=()
    createValidator() {
        local NODEPATH="$("$SERVICECTLS" "path_$1")"
        [ -d "$NODEPATH/data/tenderus/config" ] && {
            echo "Validator Node $1 already exists" >&2
            return 20
        }
        mkdir -p "$NODEPATH/data/tenderus/config" || {
            echo "Validator Node $1 preparation failed" >&2
            return 21
        }
        getFile "$(pwd)/config" "genesis.json" > "$NODEPATH/data/tenderus/config/genesis.json" || {
            echo "Failed to write Etherus genesis to Validator Node" >&2
            return 22
        }
        [ $(($1)) -gt 0 ] && [ "${ROLLOUT_VALIDATOR_PRIVATE_KEY[$(($1-1))]}" != "" ] && {
            local PRIVATE_KEY="${ROLLOUT_VALIDATOR_PRIVATE_KEY[$(($1-1))]}"
            PRIVATE_KEY="$(
                case "$PRIVATE_KEY" in
                H4sI*)
                    DECODE() { 
                        base64 -d | gunzip
                    }
                    ;;
                \{*)
                    DECODE() { 
                        cat
                    }
                    ;;
                *)
                    DECODE() { 
                        base64 -d
                    }
                esac
                ( echo "$PRIVATE_KEY" | DECODE ) 2>/dev/null
            )" && [ ! -z "$PRIVATE_KEY" ] && { #"
                echo "Using specified private key $(echo "$PRIVATE_KEY" | md5sum | sed 's/\([0-9a-fA-F]\+\).*/\1/g')"
                echo "$PRIVATE_KEY" > "$NODEPATH/data/tenderus/config/priv_validator.json"
            } || {
                echo "Failed to set private key for Validator Node $1. Using autogenerated..." >&2
            }
        }
        ( PEERS="$SNID@127.0.0.1:6656" "$SERVICECTLS" "new_$1_private" ) || {
            echo "Validator Node $1 creation failed" >&2
            return 23
        }
        local VNID="$("$SERVICECTLS" "getNodeId_$1")" || {
            echo "Failed to get Validator Node $1 ID" >&2
            return 24
        }
        echo "$VNID" | grep -Eq '^[0-9a-fA-F]{40}$' || {
            echo "Invalid Validator Node $1 ID: $VNID" >&2
            return 25
        }
        "$SERVICECTLS" "addPrivatePeer $VNID" || {
            echo "Failed to add Validator Node $1 as peer to Sentry Node" >&2
            return 26
        }
        local VALPUB="$("$SERVICECTLS" "getValidator_$1")" || {
            echo "Failed to get Validator Node $1 Public Key" >&2
            return 27
        }
        echo "$VALPUB" | grep -Eq '^0x[0-9a-fA-F]{64}$' || {
            echo "Invalid Validator Node $1 Public Key: $VALPUB" >&2
            return 28
        }
        VALPUBS+=("$VALPUB")
    }
    local COUNT="${ROLLOUT_VALIDATOR_CREATE_NUMBER:-1}"
    sequence createValidator $(seq $COUNT)
    [ ${#VALPUBS} -gt 0 ] || {
        echo "Invalid Validator Public Key: $VALPUB" >&2
        return 26
    }
    local VALPUBS="$(IFS=$'\n'; echo "${VALPUBS[*]}")"
    echo "$VALPUBS" > 'validator.pub' && {
        echo "Your Validator Public Key is saved to file: $(pwd)/validator.pub"
    } || {
        echo "Failed to write Validator Public Key to file" >&2
    }
    echo "Your validator Public Key:"
    echo "$VALPUBS" | sed 's/^/    /'
}

_cmd_install_service() {
    command -v systemctl &>/dev/null && {
        obey install_service_systemd
        return $?
    }
    echo "Failed to detect system service" >&2
    return 1
}

_cmd_install_service_systemd() {
    [ "$(id -u)" = "0" ] || {
        [ -z "$CENTOS7INSTALLSUBSHELL" ] || {
            echo "Failed to run install_service_systemd as superuser" >&2
            return 1
        }
        export CENTOS7INSTALLSUBSHELL=$$
        su "$SERVICENAME" -s "$0" install_service_systemd "$@" || {
            echo "Failed to run install_service_systemd" >&2
            return 2
        }
        return 0
    }
    [ -f "/etc/systemd/system/etherus.target" ] || getFile "$(pwd)/config/systemd" "etherus.target" > "/etc/systemd/system/etherus.target" || {
        echo "Failed to add etherus target to systemd" >&2
        return 10
    }
    [ -f "/etc/systemd/system/etherus@.service" ] || getFile "$(pwd)/config/systemd" "etherus@.service" > "/etc/systemd/system/etherus@.service" || {
        echo "Failed to add etherus service to systemd" >&2
        return 11
    }
    [ -f "/etc/systemd/system/tenderus@.service" ] || getFile "$(pwd)/config/systemd" "tenderus@.service" > "/etc/systemd/system/tenderus@.service" || {
        echo "Failed to add tenderus service to systemd" >&2
        return 12
    }
    systemctl daemon-reload || {
        echo "Failed to reload systemd daemon" >&2
        return 13
    }
    local WARNINGS=()
    local INSTALLS=0
    addDependency() {
        local OUT;
        OUT+="$(systemctl add-requires "etherus.target" "etherus@$1" 2>&1)" && {
            ((INSTALLS+=1))
        } || {
            OUT+="; $(echo "Requires=etherus@$1.service" >> '/etc/systemd/system/etherus.target')" && {
                ((INSTALLS+=1))
            } || {
                WARNINGS+=("Failed to add etherus $1 service to target: $OUT")
            }
        }
    }
    sequence addDependency $( ETHERCTLRUNPATH="$SERVICEPATH" "$SERVICECTLS" "listall" ) || {
        echo "Failed to add dependencies to target" >&2
        return 14
    }
    [ ${#WARNINGS[@]} -gt 0 ] && {
        echo "Dependencies are not added to etherus:" >&2
        (IFS=$'\n'; echo "${WARNINGS[*]}") >&2
        return 15
    }
    [ ${INSTALLS:-0} -gt 0 ] || {
        echo "No dependencies were added to etherus target" >&2
        return 16
    }
    systemctl daemon-reload || {
        echo "Failed to reload systemd daemon" >&2
        return 13
    }
    systemctl enable etherus.target && {
        echo "Etherus Daemon enabled successfully"
    } || {
        echo "Failed to enable Etherus Daemon" >&2
    }
    systemctl start etherus.target && {
        echo "Etherus Daemon started successfully"
    } || {
        echo "Failed to start Etherus Daemon" >&2
    }
    echo "Use systemctl for administration"
    systemctl list-dependencies etherus.target
}

_cmd_firewall() {
    command -v firewall-cmd &>/dev/null && {
        obey firewall_firewalld
        return $?
    }
    echo "Failed to detect system firewall" >&2
    return 1
}

_cmd_firewall_firewalld() {
    [ "$(id -u)" = "0" ] || {
        [ -z "$CENTOS7INSTALLSUBSHELL" ] || {
            echo "Failed to run firewall_firewalld as superuser" >&2
            return 1
        }
        export CENTOS7INSTALLSUBSHELL=$$
        su "$SERVICENAME" -s "$0" firewall_firewalld "$@" || {
            echo "Failed to run firewall_firewalld" >&2
            return 2
        }
        return 0
    }
    firewall-cmd --permanent --add-port=6656/tcp --add-port=6657/tcp --add-port=6660/tcp >/dev/null || {
        echo "Failed to configure etherus ports" >&2
        return 10
    }
    firewall-cmd --add-port=6656/tcp --add-port=6657/tcp --add-port=6660/tcp >/dev/null || {
        echo "Failed to open etherus ports" >&2
        return 11
    }
    echo "Firewall successfully configured for Etherus"
}

###################################################################################################

obey() {
    [ $# -eq 0 ] || {
        COMMAND="$1"
        shift
    }
    declare -F "_cmd_$COMMAND"&>/dev/null || {
        echo "Unknown command: $COMMAND"
        return -1
    }
    "_cmd_$COMMAND" "$@"
}

sequence() {
    local COMMAND="$1"
    shift
    for i in $@
    do
        $"$COMMAND" $i
    done
}

getFile() {
    [ $# -gt 1 ] && {
        local FILEPATH=$1
        shift
    }
    case "$1" in
        "genesis.json") [ -f "$FILEPATH/$1" ] && cat "$FILEPATH/$1" || cat << "#EOF#"
{
  "genesis_time": "2019-02-25T16:29:48.8917618Z",
  "chain_id": "etherus-main-chain",
  "consensus_params": {
    "block_size_params": {
      "max_bytes": "22020096",
      "max_txs": "10000",
      "max_gas": "-1"
  },
  "tx_size_params": {
      "max_bytes": "2097152",
      "max_gas": "-1"
  },
  "block_gossip_params": {
      "block_part_size_bytes": "65536"
  },
  "evidence_params": {
      "max_age": "100000"
  }
},
"validators": [
{
  "pub_key": {
    "type": "tendermint/PubKeyEd25519",
    "value": "zJMPdIPW9C1zghWHpEBhrgomU66dhDzD5VA3cGE8RXM="
},
"power": "2500",
"name": ""
}
],
"app_hash": ""
}
#EOF#
;;
"etherctl") cat << "#EOF#"
#!/usr/bin/env sh
#
# Copyright (C) 2019 Anton Filatov <ya-enot@mail.ru>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.
#
eval "$(base64 -d <<< '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' | gunzip)"
#EOF#
;;
"etherus.target") cat << "#EOF#"
[Install]
WantedBy=multi-user.target

[Unit]
Description=Etherus blockchain network
After=network.target
Requires=network.target
#EOF#
;;
"etherus@.service") cat << "#EOF#"
[Unit]
Description=Etherus service %i
PartOf=etherus.target
After=network.target
Requires=network.target
Requires=tenderus@%i.service

[Service]
User=etherus
Group=etherus
Type=forking
WorkingDirectory=/opt/etherus
OOMScoreAdjust=-999
ExecStart=/opt/etherus/etherctl start_%i_etherus
TimeoutStartSec=120
Restart=always

[Install]
WantedBy=etherus.target
#EOF#
;;
"tenderus@.service") cat << "#EOF#"
[Unit]
Description=Tenderus service %i
PartOf=etherus.target
After=network.target
Requires=network.target

[Service]
User=etherus
Group=etherus
Type=forking
WorkingDirectory=/opt/etherus
OOMScoreAdjust=-999
ExecStart=/opt/etherus/etherctl start_%i_tenderus
TimeoutStartSec=120
Restart=always

[Install]
WantedBy=etherus.target
#EOF#
;;
*) cat "$FILEPATH/$1"
;;
esac
}

obey "$@"
