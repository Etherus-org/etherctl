#!/usr/bin/env sh
#
# Copyright (C) 2019 Anton Filatov <ya-enot@mail.ru>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.
#

SERVICENAME='etherus'
SERVICEPATH='/opt/etherus'
SERVICECTLS="$SERVICEPATH/etherctl"

###################################################################################################

_cmd_() {
    obey install
}

_cmd_install() {
    obey version && \
    obey synctime || {
        local EXIT=$?
        echo "Failed to synchronise time. Please do it manually then try again."
        return $EXIT
    } && \
    obey init && \
    obey rollout "$@" && \
    echo "Etherus installed successfully" || {
        local EXIT=$?
        echo "Etherus installation failed"
        return $EXIT
    }
    obey firewall || {
        echo "Firewall was not configured"
        echo "Please open ports 6656/tcp, 6657/tcp and 6660/tcp manually..."
    }
    obey install_service || {
        echo "Etherus daemon was not installed"
    }
}

_cmd_version() {
    echo "Etherus install script v0.1.7"
}

_cmd_synctime() {
    _synctime_check_ntpenabled || {
        echo "Precise time is required by Etherus" >&2
        echo "Please check the time synchronization consistency" >&2
        _synctime_check_ntpsynced
    }
}

_synctime_check_ntpenabled() {
    local NTPENABLED;
    NTPENABLED="$( (timedatectl | grep 'NTP enabled:' | sed 's/.*: \(.*\)/\1/') 2>&1 )" && {
        case "$NTPENABLED" in
            [Yy]* ) echo "Time synchronization enabled"
            ;;
            [Nn]* ) echo "Time synchronization disabled" >&2
            return 1
            ;;
            * ) echo "Time synchronization is: $NTPENABLED" >&2
            return 2
        esac
    } || {
        echo "Failed to detect time synchronization: $NTPENABLED" >&2
        return 3
    }
}

_synctime_check_ntpsynced() {
    local NTPSYNCED;
    NTPSYNCED="$( (timedatectl | grep 'NTP synchronized:' | sed 's/.*: \(.*\)/\1/') 2>&1 )" && {
        case "$NTPSYNCED" in
            [Yy]* ) echo "Time synchronized"
            ;;
            [Nn]* ) echo "Time not synchronized" >&2
            return 1
            ;;
            * ) echo "Time synchronization state is: $NTPSYNCED" >&2
            return 2
        esac
    } || {
        echo "Failed to detect time synchronization state: $NTPSYNCED" >&2
        return 3
    }
}

_cmd_init() {
    id -u "$SERVICENAME" &>/dev/null || {
        useradd -d "$SERVICEPATH" -r -s /bin/false "$SERVICENAME" || {
            echo "Failed to create service user: $SERVICENAME" >&2
            return 1
        }
    }

    [ -d "$SERVICEPATH/" ] || {
        mkdir -m 750 -p "$SERVICEPATH/" || {
            echo "Failed to create service directory: $SERVICEPATH" >&2
            return 2
        }
        chown -R "$SERVICENAME:$SERVICENAME" "$SERVICEPATH/" || {
            echo "Failed to change service directory owner: $SERVICEPATH" >&2
            return 3
        }
    }

    [ -d "$SERVICEPATH/bin" ] || {
        mkdir -m 750 -p "$SERVICEPATH/bin" || {
            echo "Failed to create binaries directory: $SERVICEPATH" >&2
            return 4
        }
        chown -R "$SERVICENAME:$SERVICENAME" "$SERVICEPATH/bin" || {
            echo "Failed to change binaries directory owner: $SERVICEPATH" >&2
            return 5
        }
    }

    [ -x "$SERVICECTLS" ] && [ "$(cat "$SERVICECTLS" | md5sum)" = "$(getFile 'etherctl' | md5sum)" ] || {
        touch "$SERVICECTLS" && \
        chmod 755 "$SERVICECTLS" && \
        getFile 'etherctl' > "$SERVICECTLS" || {
            echo "Failed to download service control script" >&2
            return 6
        }
    }
}

_args_rollout() {
    local ARGNAME
    while [ $# -gt 0 ]
    do
        case "$1" in
        -vpk|--validator-private-key)
            ARGNAME="ROLLOUT_VALIDATOR_PRIVATE_KEY"
            ;;
        -vcn|--validator-create-number)
            ARGNAME="ROLLOUT_VALIDATOR_CREATE_NUMBER"
            ;;
        *)
            [ "$ARGNAME" = "" ] && {
                echo "Invalid parameter: $1" >&2
                return 1
            }
            case "$ARGNAME" in
            ROLLOUT_VALIDATOR_PRIVATE_KEY)
                ROLLOUT_VALIDATOR_PRIVATE_KEY+=("$1")
                ;;
            ROLLOUT_VALIDATOR_CREATE_NUMBER)
                ROLLOUT_VALIDATOR_CREATE_NUMBER=$(($1))
                ;;
            *)
                return 2
            esac
        esac
        shift # next parameter
    done
}

_cmd_rollout() {
    [ "$(id -u)" = "$(id -u "$SERVICENAME")" ] || {
        [ -z "$CENTOS7INSTALLSUBSHELL" ] || {
            echo "Failed to run rollout as $SERVICENAME" >&2
            return 1
        }
        export CENTOS7INSTALLSUBSHELL=$$
        su "$SERVICENAME" -s "$(command -v sh || command -v bash)" -c "$0 rollout $(echo "$@")" || {
            echo "Failed to run rollout" >&2
            return 2
        }
        return 0
    }
    _args_rollout "$@" || {
        local EXITCODE=$?
        echo "Failed to parse arguments for rollout: $@" >&2
        return $EXITCODE
    }
    [ -d "$SERVICEPATH/" ] && cd "$SERVICEPATH/" || {
        echo "Unable to access service directory: $SERVICEPATH" >&2
        return 3
    }
    ( PEERS="07e21d35df9ff6ecce28a5f494d95b990da305bc@master.etherus.org:6656" "$SERVICECTLS" "new" ) || {
        echo "Sentry Node creation failed" >&2
        return 10
    }
    getFile "$(pwd)/config" "genesis.json" > "$("$SERVICECTLS" "path")/data/tenderus/config/genesis.json" || {
        echo "Failed to write Etherus genesis to Sentry Node" >&2
        return 11
    }
    local SNID="$("$SERVICECTLS" "getNodeId")" || {
        echo "Failed to get Sentry Node ID" >&2
        return 12
    }
    echo "$SNID" | grep -Eq '^[0-9a-fA-F]{40}$' || {
        echo "Invalid Sentry Node ID: $SNID" >&2
        return 13
    }
    local VALPUBS=()
    createValidator() {
        local NODEPATH="$("$SERVICECTLS" "path_$1")"
        [ -d "$NODEPATH/data/tenderus/config" ] && {
            echo "Validator Node $1 already exists" >&2
            return 20
        }
        mkdir -p "$NODEPATH/data/tenderus/config" || {
            echo "Validator Node $1 preparation failed" >&2
            return 21
        }
        getFile "$(pwd)/config" "genesis.json" > "$NODEPATH/data/tenderus/config/genesis.json" || {
            echo "Failed to write Etherus genesis to Validator Node" >&2
            return 22
        }
        [ $(($1)) -gt 0 ] && [ "${ROLLOUT_VALIDATOR_PRIVATE_KEY[$(($1-1))]}" != "" ] && {
            local PRIVATE_KEY="${ROLLOUT_VALIDATOR_PRIVATE_KEY[$(($1-1))]}"
            PRIVATE_KEY="$(
                case "$PRIVATE_KEY" in
                H4sI*)
                    DECODE() { 
                        base64 -d | gunzip
                    }
                    ;;
                \{*)
                    DECODE() { 
                        cat
                    }
                    ;;
                *)
                    DECODE() { 
                        base64 -d
                    }
                esac
                ( echo "$PRIVATE_KEY" | DECODE ) 2>/dev/null
            )" && [ ! -z "$PRIVATE_KEY" ] && { #"
                echo "Using specified private key $(echo "$PRIVATE_KEY" | md5sum | sed 's/\([0-9a-fA-F]\+\).*/\1/g')"
                echo "$PRIVATE_KEY" > "$NODEPATH/data/tenderus/config/priv_validator.json"
            } || {
                echo "Failed to set private key for Validator Node $1. Using autogenerated..." >&2
            }
        }
        ( PEERS="$SNID@127.0.0.1:6656" "$SERVICECTLS" "new_$1_private" ) || {
            echo "Validator Node $1 creation failed" >&2
            return 23
        }
        local VNID="$("$SERVICECTLS" "getNodeId_$1")" || {
            echo "Failed to get Validator Node $1 ID" >&2
            return 24
        }
        echo "$VNID" | grep -Eq '^[0-9a-fA-F]{40}$' || {
            echo "Invalid Validator Node $1 ID: $VNID" >&2
            return 25
        }
        "$SERVICECTLS" "addPrivatePeer $VNID" || {
            echo "Failed to add Validator Node $1 as peer to Sentry Node" >&2
            return 26
        }
        local VALPUB="$("$SERVICECTLS" "getValidator_$1")" || {
            echo "Failed to get Validator Node $1 Public Key" >&2
            return 27
        }
        echo "$VALPUB" | grep -Eq '^0x[0-9a-fA-F]{64}$' || {
            echo "Invalid Validator Node $1 Public Key: $VALPUB" >&2
            return 28
        }
        VALPUBS+=("$VALPUB")
    }
    local COUNT="${ROLLOUT_VALIDATOR_CREATE_NUMBER:-1}"
    sequence createValidator $(seq $COUNT)
    [ ${#VALPUBS} -gt 0 ] || {
        echo "Invalid Validator Public Key: $VALPUB" >&2
        return 26
    }
    local VALPUBS="$(IFS=$'\n'; echo "${VALPUBS[*]}")"
    echo "$VALPUBS" > 'validator.pub' && {
        echo "Your Validator Public Key is saved to file: $(pwd)/validator.pub"
    } || {
        echo "Failed to write Validator Public Key to file" >&2
    }
    echo "Your validator Public Key:"
    echo "$VALPUBS" | sed 's/^/    /'
}

_cmd_install_service() {
    command -v systemctl &>/dev/null && {
        obey install_service_systemd
        return $?
    }
    echo "Failed to detect system service" >&2
    return 1
}

_cmd_install_service_systemd() {
    [ "$(id -u)" = "0" ] || {
        [ -z "$CENTOS7INSTALLSUBSHELL" ] || {
            echo "Failed to run install_service_systemd as superuser" >&2
            return 1
        }
        export CENTOS7INSTALLSUBSHELL=$$
        su "$SERVICENAME" -s "$0" install_service_systemd "$@" || {
            echo "Failed to run install_service_systemd" >&2
            return 2
        }
        return 0
    }
    [ -f "/etc/systemd/system/etherus.target" ] || getFile "$(pwd)/config/systemd" "etherus.target" > "/etc/systemd/system/etherus.target" || {
        echo "Failed to add etherus target to systemd" >&2
        return 10
    }
    [ -f "/etc/systemd/system/etherus@.service" ] || getFile "$(pwd)/config/systemd" "etherus@.service" > "/etc/systemd/system/etherus@.service" || {
        echo "Failed to add etherus service to systemd" >&2
        return 11
    }
    [ -f "/etc/systemd/system/tenderus@.service" ] || getFile "$(pwd)/config/systemd" "tenderus@.service" > "/etc/systemd/system/tenderus@.service" || {
        echo "Failed to add tenderus service to systemd" >&2
        return 12
    }
    systemctl daemon-reload || {
        echo "Failed to reload systemd daemon" >&2
        return 13
    }
    local WARNINGS=()
    local INSTALLS=0
    addDependency() {
        local OUT;
        OUT+="$(systemctl add-requires "etherus.target" "etherus@$1" 2>&1)" && {
            ((INSTALLS+=1))
        } || {
            OUT+="; $(echo "Requires=etherus@$1.service" >> '/etc/systemd/system/etherus.target')" && {
                ((INSTALLS+=1))
            } || {
                WARNINGS+=("Failed to add etherus $1 service to target: $OUT")
            }
        }
    }
    sequence addDependency $( ETHERCTLRUNPATH="$SERVICEPATH" "$SERVICECTLS" "listall" ) || {
        echo "Failed to add dependencies to target" >&2
        return 14
    }
    [ ${#WARNINGS[@]} -gt 0 ] && {
        echo "Dependencies are not added to etherus:" >&2
        (IFS=$'\n'; echo "${WARNINGS[*]}") >&2
        return 15
    }
    [ ${INSTALLS:-0} -gt 0 ] || {
        echo "No dependencies were added to etherus target" >&2
        return 16
    }
    systemctl daemon-reload || {
        echo "Failed to reload systemd daemon" >&2
        return 13
    }
    systemctl enable etherus.target && {
        echo "Etherus Daemon enabled successfully"
    } || {
        echo "Failed to enable Etherus Daemon" >&2
    }
    systemctl start etherus.target && {
        echo "Etherus Daemon started successfully"
    } || {
        echo "Failed to start Etherus Daemon" >&2
    }
    echo "Use systemctl for administration"
    systemctl list-dependencies etherus.target
}

_cmd_firewall() {
    command -v firewall-cmd &>/dev/null && {
        obey firewall_firewalld
        return $?
    }
    echo "Failed to detect system firewall" >&2
    return 1
}

_cmd_firewall_firewalld() {
    [ "$(id -u)" = "0" ] || {
        [ -z "$CENTOS7INSTALLSUBSHELL" ] || {
            echo "Failed to run firewall_firewalld as superuser" >&2
            return 1
        }
        export CENTOS7INSTALLSUBSHELL=$$
        su "$SERVICENAME" -s "$0" firewall_firewalld "$@" || {
            echo "Failed to run firewall_firewalld" >&2
            return 2
        }
        return 0
    }
    firewall-cmd --permanent --add-port=6656/tcp --add-port=6657/tcp --add-port=6660/tcp >/dev/null || {
        echo "Failed to configure etherus ports" >&2
        return 10
    }
    firewall-cmd --add-port=6656/tcp --add-port=6657/tcp --add-port=6660/tcp >/dev/null || {
        echo "Failed to open etherus ports" >&2
        return 11
    }
    echo "Firewall successfully configured for Etherus"
}

###################################################################################################

obey() {
    [ $# -eq 0 ] || {
        COMMAND="$1"
        shift
    }
    declare -F "_cmd_$COMMAND"&>/dev/null || {
        echo "Unknown command: $COMMAND"
        return -1
    }
    "_cmd_$COMMAND" "$@"
}

sequence() {
    local COMMAND="$1"
    shift
    for i in $@
    do
        $"$COMMAND" $i
    done
}

getFile() {
    [ $# -gt 1 ] && {
        local FILEPATH=$1
        shift
    }
    case "$1" in
        "genesis.json") [ -f "$FILEPATH/$1" ] && cat "$FILEPATH/$1" || cat << "#EOF#"
{
  "genesis_time": "2019-02-25T16:29:48.8917618Z",
  "chain_id": "etherus-main-chain",
  "consensus_params": {
    "block_size_params": {
      "max_bytes": "22020096",
      "max_txs": "10000",
      "max_gas": "-1"
  },
  "tx_size_params": {
      "max_bytes": "2097152",
      "max_gas": "-1"
  },
  "block_gossip_params": {
      "block_part_size_bytes": "65536"
  },
  "evidence_params": {
      "max_age": "100000"
  }
},
"validators": [
{
  "pub_key": {
    "type": "tendermint/PubKeyEd25519",
    "value": "zJMPdIPW9C1zghWHpEBhrgomU66dhDzD5VA3cGE8RXM="
},
"power": "2500",
"name": ""
}
],
"app_hash": ""
}
#EOF#
;;
"etherctl") cat << "#EOF#"
#!/usr/bin/env sh
#
# Copyright (C) 2019 Anton Filatov <ya-enot@mail.ru>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.
#
eval "$(base64 -d <<< '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' | gunzip)"
#EOF#
;;
"etherus.target") cat << "#EOF#"
[Install]
WantedBy=multi-user.target

[Unit]
Description=Etherus blockchain network
After=network.target
Requires=network.target
#EOF#
;;
"etherus@.service") cat << "#EOF#"
[Unit]
Description=Etherus service %i
PartOf=etherus.target
After=network.target
Requires=network.target
Requires=tenderus@%i.service

[Service]
User=etherus
Group=etherus
Type=forking
WorkingDirectory=/opt/etherus
OOMScoreAdjust=-999
ExecStart=/opt/etherus/etherctl start_%i_etherus
TimeoutStartSec=120
Restart=always

[Install]
WantedBy=etherus.target
#EOF#
;;
"tenderus@.service") cat << "#EOF#"
[Unit]
Description=Tenderus service %i
PartOf=etherus.target
After=network.target
Requires=network.target

[Service]
User=etherus
Group=etherus
Type=forking
WorkingDirectory=/opt/etherus
OOMScoreAdjust=-999
ExecStart=/opt/etherus/etherctl start_%i_tenderus
TimeoutStartSec=120
Restart=always

[Install]
WantedBy=etherus.target
#EOF#
;;
*) cat "$FILEPATH/$1"
;;
esac
}

obey "$@"
